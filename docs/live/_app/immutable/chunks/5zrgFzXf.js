import{s as We,n as Ct,d as U,r as de,i as Mt,b as ct,E as K,B as z,c as dt,e as wt,h as pt,k as nt,w as Oe,G as Le,D as oe,v as C,I as we,_ as Nt,g as zt,H as ne,x as Ke,j as Et,C as ee,a1 as ae,N as fe,O as he,z as Qe}from"./DzR6qLkJ.js";import{S as Ve,i as He}from"./CbSE4UIZ.js";import{c as Xe,g as an}from"./BmAGY9Gp.js";import{w as $,d as cn}from"./azyml33n.js";import{b as ls}from"./BjjGHdZ1.js";const Vt=$(null),Ht=$(44100),Ls=$(""),un=$(0),xt=$({start:0,end:5}),Ft=$(0),Lt=$(null),Bt=$(null);cn(xt,e=>e.end-e.start);function as(e){let n,t,s,r;return{c(){n=pt("div"),t=pt("canvas"),this.h()},l(l){n=dt(l,"DIV",{class:!0,role:!0,"aria-label":!0});var a=wt(n);t=dt(a,"CANVAS",{class:!0}),wt(t).forEach(U),a.forEach(U),this.h()},h(){z(t,"class","svelte-vdkqpy"),z(n,"class","waveform-container svelte-vdkqpy"),z(n,"role","application"),z(n,"aria-label","Audio waveform - click and drag to select, scroll to zoom")},m(l,a){Mt(l,n,a),ct(n,t),e[14](t),e[15](n),s||(r=[K(n,"mousedown",e[2]),K(n,"mousemove",e[3]),K(n,"mouseup",e[4]),K(n,"mouseleave",e[5]),K(n,"wheel",e[6])],s=!0)},p:Ct,i:Ct,o:Ct,d(l){l&&U(n),e[14](null),e[15](null),s=!1,de(r)}}}const bt=45,te=45;function cs(e,n,t){let s,r,l,a,u,d,h,m,w;nt(e,xt,D=>t(9,l=D)),nt(e,Ht,D=>t(22,a=D)),nt(e,Vt,D=>t(10,u=D)),nt(e,Ft,D=>t(11,d=D)),nt(e,Bt,D=>t(12,h=D)),nt(e,Lt,D=>t(13,m=D)),nt(e,Xe,D=>t(23,w=D));let x,p,c=null,k=0,B=0,P,M=!1,X=0;Oe(()=>{t(7,c=p.getContext("2d")),P=new ResizeObserver(D=>{const tt=D[0].contentRect;t(8,k=tt.width),B=tt.height,t(1,p.width=k*devicePixelRatio,p),t(1,p.height=B*devicePixelRatio,p),c&&c.scale(devicePixelRatio,devicePixelRatio),F()}),P.observe(x)}),Le(()=>{P==null||P.disconnect()});function F(){if(!c||!u||k===0)return;const D=u,tt=a,{start:G,end:W}=l,st=w.colors;if(t(7,c.fillStyle=getComputedStyle(x).getPropertyValue("--color-bg").trim()||"#1a1a1a",c),c.fillRect(0,0,k,B),t(7,c.fillStyle=getComputedStyle(x).getPropertyValue("--color-surface").trim()||"#2a2a2a",c),c.fillRect(0,0,bt,B),c.fillRect(k-te,0,te,B),t(7,c.fillStyle=st.waveform.background,c),c.fillRect(bt,0,s,B),m){const R=Math.max(m.start,G),it=Math.min(m.end,W);if(it>R){const Y=T(R,G,W),ht=T(it,G,W);t(7,c.fillStyle=st.selection.fill,c),c.fillRect(Y,0,ht-Y,B)}}const Q=Math.floor(G*tt),o=Math.ceil(W*tt),H=(o-Q)/s;let q=0;const vt=o-Q,ft=Math.max(1,Math.floor(vt/1e3));for(let R=Math.max(0,Q);R<Math.min(o,D.length);R+=ft){const it=Math.abs(D[R]);it>q&&(q=it)}const ie=q>.01?Math.min(.95/q,10):1;t(7,c.strokeStyle=st.waveform.line,c),t(7,c.lineWidth=st.waveform.lineWidth,c);const rt=B/2,_t=(B/2-4)*ie;if(c.save(),c.beginPath(),c.rect(bt,0,s,B),c.clip(),H<=1){c.beginPath();for(let R=0;R<s;R++){const it=Math.floor(Q+R*H);if(it>=0&&it<D.length){const Y=bt+R,ht=rt-D[it]*_t;R===0?c.moveTo(Y,ht):c.lineTo(Y,ht)}}c.stroke()}else{const R=[],it=[];for(let Y=0;Y<s;Y++){const ht=Math.floor(Q+Y*H),gt=Math.floor(Q+(Y+1)*H);let Pt=1/0,Tt=-1/0;for(let At=ht;At<gt&&At<D.length;At++)if(At>=0){const Qt=D[At];Qt<Pt&&(Pt=Qt),Qt>Tt&&(Tt=Qt)}Pt!==1/0?(R.push(Pt),it.push(Tt)):(R.push(0),it.push(0))}t(7,c.fillStyle=st.waveform.line,c),c.beginPath();for(let Y=0;Y<R.length;Y++){const ht=bt+Y,gt=rt-it[Y]*_t;Y===0?c.moveTo(ht,gt):c.lineTo(ht,gt)}for(let Y=R.length-1;Y>=0;Y--){const ht=bt+Y,gt=rt-R[Y]*_t;c.lineTo(ht,gt)}c.closePath(),c.fill()}if(t(7,c.strokeStyle="rgba(128, 128, 128, 0.3)",c),t(7,c.lineWidth=1,c),c.beginPath(),c.moveTo(bt,rt),c.lineTo(r,rt),c.stroke(),h!==null){const R=T(h,G,W);R>=bt&&R<=r&&(t(7,c.strokeStyle=st.cursor,c),t(7,c.lineWidth=1,c),c.setLineDash([4,4]),c.beginPath(),c.moveTo(R,0),c.lineTo(R,B),c.stroke(),c.setLineDash([]))}const Z=T(d,G,W);Z>=bt&&Z<=r&&(t(7,c.strokeStyle=st.cursor,c),t(7,c.lineWidth=st.cursorWidth,c),c.beginPath(),c.moveTo(Z,0),c.lineTo(Z,B),c.stroke()),c.restore()}function T(D,tt,G){return bt+(D-tt)/(G-tt)*s}function I(D,tt,G){return s<=0?tt:tt+(D-bt)/s*(G-tt)}function O(D){document.activeElement instanceof HTMLInputElement&&document.activeElement.blur();const tt=p.getBoundingClientRect(),G=D.clientX-tt.left;if(G<bt||G>k-te)return;const W=I(G,l.start,l.end);D.shiftKey||(M=!0,X=W,Ft.set(W),Lt.set(null))}function N(D){const tt=p.getBoundingClientRect(),G=D.clientX-tt.left;if(G<bt||G>k-te){Bt.set(null);return}const W=I(G,l.start,l.end);Bt.set(W),M&&(Math.abs(W-X)>.001&&Lt.set({start:Math.min(X,W),end:Math.max(X,W)}),Ft.set(W))}function L(){M=!1}function ot(){M=!1,Bt.set(null)}function V(D){D.preventDefault();const tt=p.getBoundingClientRect(),G=D.clientX-tt.left,W=I(G,l.start,l.end),st=u?u.length/a:10,{start:Q,end:o}=l,H=o-Q;if(Math.abs(D.deltaX)>Math.abs(D.deltaY)){const _t=D.deltaX/s*H;let Z=Q+_t,R=o+_t;Z<0&&(Z=0,R=H),R>st&&(R=st,Z=st-H),xt.set({start:Z,end:R});return}const q=D.deltaY>0?1.1:.91,vt=Math.max(.01,Math.min(st,H*q)),ft=(W-Q)/H,ie=Math.max(0,W-ft*vt),rt=Math.min(st,ie+vt);xt.set({start:Math.max(0,rt-vt),end:rt})}function It(D){oe[D?"unshift":"push"](()=>{p=D,t(1,p)})}function Dt(D){oe[D?"unshift":"push"](()=>{x=D,t(0,x)})}return e.$$.update=()=>{e.$$.dirty&256&&(s=Math.max(0,k-bt-te)),e.$$.dirty&256&&(r=k-te),e.$$.dirty&16256&&c&&u&&k>0&&l&&m!==void 0&&d!==void 0&&h!==void 0&&F()},[x,p,O,N,L,ot,V,c,k,l,u,d,h,m,It,Dt]}class Vs extends Ve{constructor(n){super(),He(this,n,cs,as,We,{})}}const se=$(!1),ue=$(null);let Xt=null,ce=null;const us={"praatfan-gpl":"https://ucpresearch.github.io/praatfan-core-rs/pkg/praatfan_gpl.js",praatfan:"https://ucpresearch.github.io/praatfan-core-clean/pkg/praatfan.js"};function fs(e){return e==="praatfan-local"?`${ls}/wasm/praatfan/praatfan.js`:us[e]}const hs={"praatfan-gpl":"praatfan-gpl",praatfan:"praatfan","praatfan-local":"praatfan"};async function Hs(e="praatfan-local"){C(ue)===e&&Xt||ce&&(await ce,C(ue)===e&&Xt)||(se.set(!1),Xt=null,ce=(async()=>{try{const t=fs(e);console.log(`Loading WASM module from ${t}...`);const s=await import(t);await s.default(),(e==="praatfan"||e==="praatfan-local")&&typeof s.init=="function"&&s.init(),Xt=s,ue.set(e),se.set(!0),console.log(`WASM acoustic analysis module initialized (${e})`)}catch(t){throw Xt=null,ue.set(null),se.set(!1),console.error("Failed to initialize WASM module:",t),t}finally{ce=null}})(),await ce)}function Pe(){if(!Xt)throw new Error("WASM module not initialized. Call initWasm() first.");return Xt}function ms(){const e=C(ue);if(!e)throw new Error("No backend loaded. Call initWasm() first.");return e}function Jt(){const e=ms();return hs[e]}function fn(e,n,t,s){return Jt()==="praatfan-gpl"?e.to_pitch(n,t,s):e.to_pitch_ac(n,t,s)}function hn(e,n,t){return e.to_intensity(n,t)}function mn(e,n,t,s,r,l){return e.to_formant_burg(n,t,s,r,l)}function dn(e,n,t,s,r){return e.to_harmonicity_ac(n,t,s,r)}function ke(e,n,t,s,r){return Jt()==="praatfan-gpl"?e.to_spectrogram(n,t,s,r,"gaussian"):e.to_spectrogram(n,t,s,r)}function ds(e,n){return e.to_spectrum(n)}function pn(e){return e.times()}function gn(e){return e.values()}function yn(e,n){if(Jt()==="praatfan-gpl")return e.get_value_at_time(n,"cubic");{const s=e.times(),r=e.values();return Fe(s,r,n)}}function Wt(e,n,t){if(Jt()==="praatfan-gpl")return e.get_value_at_time(n,t,"hertz","linear");{const r=e.times(),l=e.formant_values(n);return Fe(r,l,t)}}function Ot(e,n,t){if(Jt()==="praatfan-gpl")return e.get_bandwidth_at_time(n,t,"hertz","linear");{const r=e.times(),l=e.bandwidth_values(n);return Fe(r,l,t)}}function wn(e,n){if(Jt()==="praatfan-gpl")return e.get_value_at_time(n,"linear");{const s=e.times(),r=e.values();return Fe(s,r,n)}}function Ne(e){return Jt()==="praatfan-gpl"?{values:e.values(),freqMin:e.freq_min,freqMax:e.freq_max,timeMin:e.start_time,timeMax:e.start_time+(e.num_frames-1)*e.time_step,nFreqs:e.num_freq_bins,nTimes:e.num_frames}:{values:e.values(),freqMin:e.freq_min(),freqMax:e.freq_max(),timeMin:e.time_min(),timeMax:e.time_max(),nFreqs:e.n_freqs(),nTimes:e.n_times()}}function Fe(e,n,t){if(e.length===0)return NaN;if(e.length===1)return n[0];const s=e.length>1?e[1]-e[0]:1,r=e[0],l=(t-r)/s;if(l<=0)return n[0];if(l>=e.length-1)return n[e.length-1];const a=Math.floor(l),u=a+1,d=l-a,h=n[a],m=n[u];return isNaN(h)&&isNaN(m)?NaN:isNaN(h)?m:isNaN(m)?h:h+d*(m-h)}const De=$(!1),lt=$(0),re=$(null),bn=$({timeStep:.01,pitchFloor:75,pitchCeiling:600,maxFormant:5500,numFormants:5}),Gt=60;async function Xs(){const e=C(Vt),n=C(Ht),t=C(se);if(!e||!t){console.warn("Cannot run analysis: audio or WASM not ready");return}const s=C(un);if(s>Gt){console.log(`Audio duration ${s.toFixed(1)}s exceeds ${Gt}s limit, skipping analysis`),re.set(null);return}De.set(!0),lt.set(0);try{const r=C(bn),l=an(),a=Pe(),u=new a.Sound(e,n);try{lt.set(10);const d=fn(u,r.timeStep,r.pitchFloor,r.pitchCeiling);let h,m,w,x;try{lt.set(25),h=hn(u,r.pitchFloor,r.timeStep),lt.set(40),m=mn(u,r.timeStep,r.numFormants,l.maxFormant,.025,50),lt.set(55),w=dn(u,r.timeStep,r.pitchFloor,.1,4.5),lt.set(70);const p=Array.from(pn(d)),c=Array.from(gn(d));lt.set(75),x=ke(u,.005,5e3,.002,20),lt.set(85);const k=xn(e,n,p,c,a),B=Ne(x);lt.set(95);const P={times:p,pitch:c.map(M=>isNaN(M)||M===0?null:M),intensity:p.map(M=>{const X=yn(h,M);return isNaN(X)?null:X}),formants:{f1:p.map(M=>at(Wt(m,1,M))),f2:p.map(M=>at(Wt(m,2,M))),f3:p.map(M=>at(Wt(m,3,M))),f4:p.map(M=>at(Wt(m,4,M))),b1:p.map(M=>at(Ot(m,1,M))),b2:p.map(M=>at(Ot(m,2,M))),b3:p.map(M=>at(Ot(m,3,M))),b4:p.map(M=>at(Ot(m,4,M)))},harmonicity:p.map(M=>at(wn(w,M))),cog:k.cog,spectralTilt:k.spectralTilt,a1p0:k.a1p0,nmr:k.nmr,spectrogram:B};lt.set(100),re.set(P)}finally{d.free();try{h==null||h.free()}catch{}try{m==null||m.free()}catch{}try{w==null||w.free()}catch{}try{x==null||x.free()}catch{}}}finally{u.free()}}catch(r){throw console.error("Analysis failed:",r),r}finally{De.set(!1)}}function at(e){return isNaN(e)||e===0?null:e}async function ps(e,n){const t=C(Vt),s=C(Ht),r=C(se);if(!t||!r){console.warn("Cannot run analysis: audio or WASM not ready");return}const l=n-e;if(l>Gt){console.log(`Range ${l.toFixed(1)}s exceeds ${Gt}s limit`);return}De.set(!0),lt.set(0);try{const a=C(bn),u=an(),d=Pe(),h=.1,m=Math.max(0,e-h),w=Math.min(t.length/s,n+h),x=Math.floor(m*s),p=Math.ceil(w*s),c=t.slice(x,p),k=new d.Sound(c,s);try{lt.set(15);const B=fn(k,a.timeStep,a.pitchFloor,a.pitchCeiling);let P,M,X,F;try{lt.set(30),P=hn(k,a.pitchFloor,a.timeStep),lt.set(45),M=mn(k,a.timeStep,a.numFormants,u.maxFormant,.025,50),lt.set(60),X=dn(k,a.timeStep,a.pitchFloor,.1,4.5),lt.set(75);const T=Array.from(pn(B)),I=T.map(V=>V+m),O=Array.from(gn(B));lt.set(85),F=ke(k,.005,5e3,.002,20);const N=xn(c,s,T,O,d),L=Ne(F);L.timeMin=m,L.timeMax=w,lt.set(95);const ot={times:I,pitch:O.map(V=>isNaN(V)||V===0?null:V),intensity:I.map((V,It)=>{const Dt=yn(P,T[It]);return isNaN(Dt)?null:Dt}),formants:{f1:T.map(V=>at(Wt(M,1,V))),f2:T.map(V=>at(Wt(M,2,V))),f3:T.map(V=>at(Wt(M,3,V))),f4:T.map(V=>at(Wt(M,4,V))),b1:T.map(V=>at(Ot(M,1,V))),b2:T.map(V=>at(Ot(M,2,V))),b3:T.map(V=>at(Ot(M,3,V))),b4:T.map(V=>at(Ot(M,4,V)))},harmonicity:T.map(V=>at(wn(X,V))),cog:N.cog,spectralTilt:N.spectralTilt,a1p0:N.a1p0,nmr:N.nmr,spectrogram:L};lt.set(100),re.set(ot),console.log(`Analysis completed for range ${e.toFixed(1)}s - ${n.toFixed(1)}s`)}finally{B.free();try{P==null||P.free()}catch{}try{M==null||M.free()}catch{}try{X==null||X.free()}catch{}try{F==null||F.free()}catch{}}}finally{k.free()}}catch(a){throw console.error("Range analysis failed:",a),a}finally{De.set(!1)}}function xn(e,n,t,s,r){const u=Math.floor(.025*n),d=[],h=[],m=[],w=[];for(let x=0;x<t.length;x++){const p=t[x],c=s[x],k=Math.max(0,Math.floor((p-.0125)*n)),B=Math.min(e.length,k+u);if(B-k<u/2){d.push(null),h.push(null),m.push(null),w.push(null);continue}let P=null,M=null;try{const X=e.slice(k,B);P=new r.Sound(X,n),M=ds(P,!0);const F=M.get_center_of_gravity(2);d.push(isNaN(F)||F<=0?null:F);const T=M.get_band_energy(0,500),I=M.get_band_energy(2e3,4e3);if(T>0&&I>0){const N=10*Math.log10(T)-10*Math.log10(I);h.push(isNaN(N)?null:N)}else h.push(null);const O=M.get_band_energy(0,5e3);if(O>0&&T>0){const N=T/O;w.push(isNaN(N)?null:N)}else w.push(null);if(c&&!isNaN(c)&&c>0){const N=M.get_band_energy(c*.9,c*1.1),L=M.get_band_energy(200,300);if(N>0&&L>0){const ot=10*Math.log10(N)-10*Math.log10(L);m.push(isNaN(ot)?null:ot)}else m.push(null)}else m.push(null)}catch{d.push(null),h.push(null),m.push(null),w.push(null)}finally{try{M==null||M.free()}catch{}try{P==null||P.free()}catch{}}}return{cog:d,spectralTilt:h,a1p0:m,nmr:w}}function Gs(){re.set(null),lt.set(0)}const pe=$(!1),Ee=$("full");let me=null,Rt=null,Mn=0,Se=0,Be=0,_e=null;function gs(){return me||(me=new AudioContext),me}function ys(){const e=C(Vt),n=C(Ht);if(!e)return;e.length/n;const t=C(Ft),s=C(Lt),r=C(xt);let l,a;s&&s.end>s.start?(l=s.start,a=s.end,Ee.set("selection")):(l=t,a=r.end,Ee.set("visible")),Ge(l,a)}function Ge(e,n){Ae();const t=C(Vt),s=C(Ht);if(!t)return;const r=gs(),a=Math.ceil(.3*s),u=t.length+a,d=r.createBuffer(1,u,s),h=d.getChannelData(0);for(let m=0;m<t.length;m++)h[m]=t[m];Rt=r.createBufferSource(),Rt.buffer=d,Rt.connect(r.destination),Se=Math.max(0,e),Be=Math.min(t.length/s,n),Mn=r.currentTime,Rt.start(0,Se,Be-Se),pe.set(!0),Rt.onended=()=>{Ae()},Tn()}function js(){const e=C(xt);Ee.set("visible"),Ge(e.start,e.end)}function vn(){Rt&&(Rt.stop(),Rt.disconnect(),Rt=null),_e!==null&&(cancelAnimationFrame(_e),_e=null),pe.set(!1)}function Ae(){vn();const e=C(Lt);e&&Ft.set(e.start)}function Us(){C(pe)?vn():ys()}function Tn(){if(!C(pe)||!me)return;const e=me.currentTime-Mn,n=Se+e;if(n>=Be){Ae();return}Ft.set(n),_e=requestAnimationFrame(Tn)}function ws(e){const n=e.split(/\r?\n/);let t=0;function s(){for(;t<n.length&&n[t].trim()==="";)t++;return t<n.length?n[t++].trim():""}const r=s();if(!r)throw new Error("Empty or invalid TextGrid file");const l=r==='"ooTextFile"'||!r.includes("=");return t=0,l?bs(n):xs(n)}function bs(e){let n=0;const t=[];function s(){for(;n<e.length&&e[n].trim()==="";)n++;return n<e.length?e[n++].trim():""}function r(){return s().replace(/^"|"$/g,"").replace(/""/g,'"')}function l(){const h=parseFloat(s());if(isNaN(h))throw new Error("Invalid number in TextGrid file");return h}r(),r();const a=l(),u=l();s();const d=l();for(let h=0;h<d;h++){const m=r(),w=r();l(),l();const x=l(),p={name:w,type:m==="IntervalTier"?"interval":"point",intervals:[]};for(let c=0;c<x;c++)if(p.type==="interval"){const k=l(),B=l(),P=r();p.intervals.push({start:k,end:B,text:P})}else{const k=l(),B=r();p.intervals.push({start:k,end:k,text:B})}t.push(p)}return{tiers:t,xmin:a,xmax:u}}function xs(e){let n=0;const t=[];function s(){for(;n<e.length&&e[n].trim()==="";)n++;return n<e.length?e[n++].trim():""}function r(h){const m=h.match(/=\s*(.+)$/);return m?m[1].trim():h.trim()}function l(h){const m=parseFloat(r(h));if(isNaN(m))throw new Error(`Invalid number in TextGrid file: ${h}`);return m}function a(h){return r(h).replace(/^"|"$/g,"").replace(/""/g,'"')}s(),s();let u=0,d=0;for(;n<e.length;){const h=s();if(h.startsWith("xmin"))u=l(h);else if(h.startsWith("xmax"))d=l(h);else if(h.includes("size =")){const m=l(h);s();for(let w=0;w<m;w++){s();const x=s(),p=a(x),c=s(),k=a(c),B=s();l(B);const P=s();l(P);const M=s(),X=l(M),F={name:k,type:p==="IntervalTier"?"interval":"point",intervals:[]};for(let T=0;T<X;T++)if(s(),F.type==="interval"){const I=l(s()),O=l(s()),N=a(s());F.intervals.push({start:I,end:O,text:N})}else{const I=l(s()),O=a(s());F.intervals.push({start:I,end:I,text:O})}t.push(F)}break}}return{tiers:t,xmin:u,xmax:d}}function Ms(e,n,t){const s=[];s.push('File type = "ooTextFile"'),s.push('Object class = "TextGrid"'),s.push(""),s.push(`xmin = ${n}`),s.push(`xmax = ${t}`),s.push("tiers? <exists>"),s.push(`size = ${e.length}`),s.push("item []:");for(let r=0;r<e.length;r++){const l=e[r];s.push(`    item [${r+1}]:`),s.push(`        class = "${l.type==="interval"?"IntervalTier":"TextTier"}"`),s.push(`        name = "${ze(l.name)}"`);const a=l.intervals.length>0?l.intervals[0].start:n,u=l.intervals.length>0?l.intervals[l.intervals.length-1].end:t;if(s.push(`        xmin = ${a}`),s.push(`        xmax = ${u}`),l.type==="interval"){s.push(`        intervals: size = ${l.intervals.length}`);for(let d=0;d<l.intervals.length;d++){const h=l.intervals[d];s.push(`        intervals [${d+1}]:`),s.push(`            xmin = ${h.start}`),s.push(`            xmax = ${h.end}`),s.push(`            text = "${ze(h.text)}"`)}}else{s.push(`        points: size = ${l.intervals.length}`);for(let d=0;d<l.intervals.length;d++){const h=l.intervals[d];s.push(`        points [${d+1}]:`),s.push(`            number = ${h.start}`),s.push(`            mark = "${ze(h.text)}"`)}}}return s.join(`
`)}function ze(e){return e.replace(/"/g,'""')}const vs=50,Re=$([]),Ce=$([]);let jt=null,Ut=null;function je(){if(!jt)return[];let e=[];return jt.subscribe(t=>{e=t})(),e}function Ue(){if(!Ut)return[];let e=[];return Ut.subscribe(t=>{e=t})(),e}function Ys(e,n){jt=e,Ut=n}function Zt(){const e={tiers:JSON.parse(JSON.stringify(je())),dataPoints:JSON.parse(JSON.stringify(Ue()))};Re.update(n=>{const t=[...n,e];return t.length>vs&&t.shift(),t}),Ce.set([])}function Js(){const e=C(Re);if(e.length===0)return!1;const n={tiers:JSON.parse(JSON.stringify(je())),dataPoints:JSON.parse(JSON.stringify(Ue()))};Ce.update(s=>[...s,n]);const t=e[e.length-1];return Re.update(s=>s.slice(0,-1)),jt&&jt.set(t.tiers),Ut&&Ut.set(t.dataPoints),!0}function Zs(){const e=C(Ce);if(e.length===0)return!1;const n={tiers:JSON.parse(JSON.stringify(je())),dataPoints:JSON.parse(JSON.stringify(Ue()))};Re.update(s=>[...s,n]);const t=e[e.length-1];return Ce.update(s=>s.slice(0,-1)),jt&&jt.set(t.tiers),Ut&&Ut.set(t.dataPoints),!0}const ut=$([]),Yt=$(0);cn([ut,Yt],([e,n])=>e[n]||null);const Ts=$(null);function Ks(e){try{const{tiers:n}=ws(e);Zt(),ut.set(n),Yt.set(0),Ts.set(null)}catch(n){throw console.error("Failed to parse TextGrid:",n),n}}function Qs(){const e=C(Vt),n=C(Ht),t=e?e.length/n:1;return Ms(C(ut),0,t)}function Ss(e,n="interval"){const t=C(Vt),s=C(Ht),r=t?t.length/s:1,l={name:e,type:n,intervals:n==="interval"?[{start:0,end:r,text:""}]:[]};ut.update(a=>[...a,l])}function $s(e){ut.update(t=>t.filter((s,r)=>r!==e));const n=C(Yt);n>=e&&n>0&&Yt.update(t=>t-1)}function to(e,n){ut.update(t=>t.map((s,r)=>r===e?{...s,name:n}:s))}const $e=.05;function Sn(e,n,t){for(let s=0;s<n;s++){const r=t[s];if(r.type==="interval")for(const l of r.intervals){if(Math.abs(l.start-e)<=$e)return l.start;if(Math.abs(l.end-e)<=$e)return l.end}}return null}function eo(e){const n=C(Yt),t=C(ut);if(n<0||n>=t.length)return;const s=t[n];if(s.type!=="interval")return;const r=Sn(e,n,t),l=r!==null?r:e,a=s.intervals.findIndex(m=>l>m.start&&l<m.end);if(a===-1)return;Zt();const u=s.intervals[a],d={start:u.start,end:l,text:u.text},h={start:l,end:u.end,text:""};ut.update(m=>{const w=[...m];return w[n]={...w[n],intervals:[...w[n].intervals.slice(0,a),d,h,...w[n].intervals.slice(a+1)]},w})}function no(e){const n=C(Yt),t=C(ut);if(n<0||n>=t.length||e<=0)return;const s=t[n];s.type==="interval"&&(e>=s.intervals.length||(Zt(),ut.update(r=>{const l=[...r],a=[...l[n].intervals],u=a[e-1],d=a[e],h={start:u.start,end:d.end,text:u.text||d.text};return a.splice(e-1,2,h),l[n]={...l[n],intervals:a},l})))}function so(e,n,t){const s=C(ut);if(e<s.length&&n<s[e].intervals.length){if(s[e].intervals[n].text===t)return;Zt()}ut.update(r=>{const l=[...r];return e<l.length&&n<l[e].intervals.length&&(l[e]={...l[e],intervals:l[e].intervals.map((a,u)=>u===n?{...a,text:t}:a)}),l})}function oo(e,n){const t=C(Yt),s=C(ut);if(t<0||t>=s.length||e<=0)return;const r=s[t];if(e>=r.intervals.length)return;const l=r.intervals[e-1],a=r.intervals[e],u=Sn(n,t,s),d=u!==null?u:n;d<=l.start||d>=a.end||ut.update(h=>{const m=[...h],w=[...m[t].intervals];return w[e-1]={...w[e-1],end:d},w[e]={...w[e],start:d},m[t]={...m[t],intervals:w},m})}function ro(){if(C(ut).length===0){const n=C(Xe);for(const t of n.annotation.defaultTiers)Ss(t)}}const Kt=$([]),be=$(null),xe=$(null);let _n=1;function Pn(e,n){Zt();const t=kn(e),s=Ye(e),r={id:_n++,time:e,frequency:n,acousticValues:t,annotationIntervals:s};return Kt.update(l=>[...l,r]),r}function _s(e){Zt();let n=null;return Kt.update(t=>{const s=t.findIndex(r=>r.id===e);return s!==-1?(n=t[s],[...t.slice(0,s),...t.slice(s+1)]):t}),n}function Ps(e,n,t){let s=!1;return Kt.update(r=>r.map(l=>{if(l.id===e){s=!0;const a=kn(n),u=Ye(n);return{...l,time:n,frequency:t,acousticValues:a,annotationIntervals:u}}return l})),s}function Me(e,n,t=.02,s=100){const r=C(Kt);let l=null,a=1/0;for(const u of r){const d=Math.abs(u.time-e),h=Math.abs(u.frequency-n);if(d<=t&&h<=s){const m=(d/t)**2+(h/s)**2;m<a&&(a=m,l=u)}}return l}function ks(){Kt.set([]),_n=1}function kn(e){const n=C(re);if(!n)return{};const{times:t}=n;if(!t||t.length===0)return{};let s=0,r=1/0;for(let l=0;l<t.length;l++){const a=Math.abs(t[l]-e);a<r&&(r=a,s=l)}return{Pitch:n.pitch[s],Intensity:n.intensity[s],F1:n.formants.f1[s],F2:n.formants.f2[s],F3:n.formants.f3[s],F4:n.formants.f4[s],B1:n.formants.b1[s],B2:n.formants.b2[s],B3:n.formants.b3[s],B4:n.formants.b4[s],HNR:n.harmonicity[s],CoG:n.cog[s],SpectralTilt:n.spectralTilt[s],"A1-P0":n.a1p0[s],NMR:n.nmr?n.nmr[s]:null}}function Ye(e){const n=C(ut),t={};for(const s of n)for(const r of s.intervals)if(e>=r.start&&e<r.end){t[s.name]=r.text;break}return t}function Ns(e,n){if(!n)return e;const t=[];for(const s of e){const r=s.toLowerCase();r==="pitch"||r==="f0"?n.showPitch&&t.push(s):r.startsWith("f")&&/^f[1-4]$/.test(r)||r.startsWith("b")&&/^b[1-4]$/.test(r)?n.showFormants&&t.push(s):r==="intensity"?n.showIntensity&&t.push(s):r==="hnr"||r==="harmonicity"?n.showHNR&&t.push(s):r==="cog"||r==="centerofgravity"?n.showCoG&&t.push(s):r==="spectraltilt"||r==="tilt"?n.showSpectralTilt&&t.push(s):r==="a1p0"||r==="a1-p0"?n.showA1P0&&t.push(s):r==="nmr"?n.showNMR&&t.push(s):t.push(s)}return t}function io(e){const n=C(Kt),t=C(ut);if(n.length===0)return`time	frequency
`;const s=new Set;for(const w of n)Object.keys(w.acousticValues).forEach(x=>s.add(x));const r=Array.from(s).sort(),l=Ns(r,e),a=t.map(w=>w.name),u=["time","frequency",...l,...a],h=[...n].sort((w,x)=>w.time-x.time).map(w=>{const x=[w.time.toFixed(4),w.frequency.toFixed(1)];for(const c of l){const k=w.acousticValues[c];x.push(k!=null?k.toFixed(2):"")}const p=Ye(w.time);for(const c of a)x.push(p[c]||"");return x});return[u.join("	"),...h.map(w=>w.join("	"))].join(`
`)}function lo(e){const n=e.trim().split(`
`);if(n.length<2)return-1;const t=n[0].split("	").map(a=>a.trim().toLowerCase()),s=t.indexOf("time"),r=t.indexOf("frequency");if(s===-1||r===-1)return-1;ks();let l=0;for(let a=1;a<n.length;a++){const u=n[a].trim();if(!u)continue;const d=u.split("	"),h=parseFloat(d[s]),m=parseFloat(d[r]);!isNaN(h)&&!isNaN(m)&&(Pn(h,m),l++)}return l}function tn(e){let n,t="Computing spectrogram...";return{c(){n=pt("div"),n.textContent=t,this.h()},l(s){n=dt(s,"DIV",{class:!0,"data-svelte-h":!0}),ne(n)!=="svelte-vvjva"&&(n.textContent=t),this.h()},h(){z(n,"class","computing svelte-1r84lea")},m(s,r){Mt(s,n,r)},d(s){s&&U(n)}}}function en(e){let n,t,s;function r(u,d){return u[11]?As:Ds}let l=r(e),a=l(e);return{c(){n=pt("button"),a.c(),this.h()},l(u){n=dt(u,"BUTTON",{class:!0,style:!0,title:!0});var d=wt(n);a.l(d),d.forEach(U),this.h()},h(){z(n,"class","play-selection-btn svelte-1r84lea"),ee(n,"left",e[10]+4+"px"),z(n,"title","Play selection")},m(u,d){Mt(u,n,d),a.m(n,null),t||(s=[K(n,"mousedown",Nt(e[57])),K(n,"click",Nt(e[21]))],t=!0)},p(u,d){l!==(l=r(u))&&(a.d(1),a=l(u),a&&(a.c(),a.m(n,null))),d[0]&1024&&ee(n,"left",u[10]+4+"px")},d(u){u&&U(n),a.d(),t=!1,de(s)}}}function Ds(e){let n,t;return{c(){n=he("svg"),t=he("path"),this.h()},l(s){n=fe(s,"svg",{viewBox:!0,fill:!0,width:!0,height:!0});var r=wt(n);t=fe(r,"path",{d:!0}),wt(t).forEach(U),r.forEach(U),this.h()},h(){z(t,"d","M8 5v14l11-7z"),z(n,"viewBox","0 0 24 24"),z(n,"fill","currentColor"),z(n,"width","14"),z(n,"height","14")},m(s,r){Mt(s,n,r),ct(n,t)},d(s){s&&U(n)}}}function As(e){let n,t,s;return{c(){n=he("svg"),t=he("rect"),s=he("rect"),this.h()},l(r){n=fe(r,"svg",{viewBox:!0,fill:!0,width:!0,height:!0});var l=wt(n);t=fe(l,"rect",{x:!0,y:!0,width:!0,height:!0}),wt(t).forEach(U),s=fe(l,"rect",{x:!0,y:!0,width:!0,height:!0}),wt(s).forEach(U),l.forEach(U),this.h()},h(){z(t,"x","6"),z(t,"y","4"),z(t,"width","4"),z(t,"height","16"),z(s,"x","14"),z(s,"y","4"),z(s,"width","4"),z(s,"height","16"),z(n,"viewBox","0 0 24 24"),z(n,"fill","currentColor"),z(n,"width","14"),z(n,"height","14")},m(r,l){Mt(r,n,l),ct(n,t),ct(n,s)},d(r){r&&U(n)}}}function nn(e){let n,t='<svg viewBox="0 0 24 24" fill="currentColor" width="14" height="14"><path d="M3 5v4h2V5h4V3H5c-1.1 0-2 .9-2 2zm2 10H3v4c0 1.1.9 2 2 2h4v-2H5v-4zm14 4h-4v2h4c1.1 0 2-.9 2-2v-4h-2v4zm0-16h-4v2h4v4h2V5c0-1.1-.9-2-2-2z"></path></svg>',s,r;return{c(){n=pt("button"),n.innerHTML=t,this.h()},l(l){n=dt(l,"BUTTON",{class:!0,title:!0,"data-svelte-h":!0}),ne(n)!=="svelte-9j0vt3"&&(n.innerHTML=t),this.h()},h(){z(n,"class","zoom-btn svelte-1r84lea"),z(n,"title","Zoom to selection")},m(l,a){Mt(l,n,a),s||(r=[K(n,"mousedown",Nt(e[54])),K(n,"click",Nt(e[24]))],s=!0)},p:Ct,d(l){l&&U(n),s=!1,de(r)}}}function sn(e){let n,t,s,r,l="Remove data point",a,u;return{c(){n=pt("div"),t=Et(),s=pt("div"),r=pt("button"),r.textContent=l,this.h()},l(d){n=dt(d,"DIV",{class:!0}),wt(n).forEach(U),t=zt(d),s=dt(d,"DIV",{class:!0,style:!0});var h=wt(s);r=dt(h,"BUTTON",{class:!0,"data-svelte-h":!0}),ne(r)!=="svelte-8fgbhx"&&(r.textContent=l),h.forEach(U),this.h()},h(){z(n,"class","context-menu-backdrop svelte-1r84lea"),z(r,"class","context-menu-item svelte-1r84lea"),z(s,"class","context-menu svelte-1r84lea"),ee(s,"left",e[9].x+"px"),ee(s,"top",e[9].y+"px")},m(d,h){Mt(d,n,h),Mt(d,t,h),Mt(d,s,h),ct(s,r),a||(u=[K(n,"click",e[18]),K(r,"click",e[19])],a=!0)},p(d,h){h[0]&512&&ee(s,"left",d[9].x+"px"),h[0]&512&&ee(s,"top",d[9].y+"px")},d(d){d&&(U(n),U(t),U(s)),a=!1,de(u)}}}function Rs(e){let n,t,s,r,l,a,u,d='<svg viewBox="0 0 24 24" fill="currentColor" width="14" height="14"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"></path></svg>',h,m,w='<svg viewBox="0 0 24 24" fill="currentColor" width="14" height="14"><path d="M19 13H5v-2h14v2z"></path></svg>',x,p,c,k='<svg viewBox="0 0 24 24" fill="currentColor" width="14" height="14"><path d="M4 4h6v6H4zm10 0h6v6h-6zM4 14h6v6H4zm10 0h6v6h-6z"></path></svg>',B,P,M,X,F=(e[7]||!e[0]&&!e[1]&&!e[2])&&tn(),T=e[3]&&e[0]&&en(e),I=e[3]&&nn(e),O=e[9]&&sn(e);return{c(){n=pt("div"),F&&F.c(),t=Et(),s=pt("canvas"),r=Et(),T&&T.c(),l=Et(),a=pt("div"),u=pt("button"),u.innerHTML=d,h=Et(),m=pt("button"),m.innerHTML=w,x=Et(),I&&I.c(),p=Et(),c=pt("button"),c.innerHTML=k,B=Et(),O&&O.c(),P=Ke(),this.h()},l(N){n=dt(N,"DIV",{class:!0,role:!0,"aria-label":!0});var L=wt(n);F&&F.l(L),t=zt(L),s=dt(L,"CANVAS",{class:!0}),wt(s).forEach(U),r=zt(L),T&&T.l(L),l=zt(L),a=dt(L,"DIV",{class:!0});var ot=wt(a);u=dt(ot,"BUTTON",{class:!0,title:!0,"data-svelte-h":!0}),ne(u)!=="svelte-r6msr3"&&(u.innerHTML=d),h=zt(ot),m=dt(ot,"BUTTON",{class:!0,title:!0,"data-svelte-h":!0}),ne(m)!=="svelte-q25joc"&&(m.innerHTML=w),x=zt(ot),I&&I.l(ot),p=zt(ot),c=dt(ot,"BUTTON",{class:!0,title:!0,"data-svelte-h":!0}),ne(c)!=="svelte-dflweb"&&(c.innerHTML=k),ot.forEach(U),L.forEach(U),B=zt(N),O&&O.l(N),P=Ke(),this.h()},h(){z(s,"class","svelte-1r84lea"),z(u,"class","zoom-btn svelte-1r84lea"),z(u,"title","Zoom in"),z(m,"class","zoom-btn svelte-1r84lea"),z(m,"title","Zoom out"),z(c,"class","zoom-btn svelte-1r84lea"),z(c,"title","Zoom to fit"),z(a,"class","zoom-controls svelte-1r84lea"),z(n,"class","spectrogram-container svelte-1r84lea"),z(n,"role","application"),z(n,"aria-label","Spectrogram - click and drag to select, scroll to zoom, double-click to add data point"),we(n,"grabbing",e[8]),we(n,"can-grab",e[4]!==null&&!e[8])},m(N,L){Mt(N,n,L),F&&F.m(n,null),ct(n,t),ct(n,s),e[59](s),ct(n,r),T&&T.m(n,null),ct(n,l),ct(n,a),ct(a,u),ct(a,h),ct(a,m),ct(a,x),I&&I.m(a,null),ct(a,p),ct(a,c),e[60](n),Mt(N,B,L),O&&O.m(N,L),Mt(N,P,L),M||(X=[K(window,"keydown",e[58]),K(u,"mousedown",Nt(e[56])),K(u,"click",Nt(e[22])),K(m,"mousedown",Nt(e[55])),K(m,"click",Nt(e[23])),K(c,"mousedown",Nt(e[53])),K(c,"click",Nt(e[25])),K(n,"mousedown",e[12]),K(n,"mousemove",e[13]),K(n,"mouseup",e[14]),K(n,"mouseleave",e[15]),K(n,"dblclick",e[16]),K(n,"contextmenu",e[17]),K(n,"wheel",e[20])],M=!0)},p(N,L){N[7]||!N[0]&&!N[1]&&!N[2]?F||(F=tn(),F.c(),F.m(n,t)):F&&(F.d(1),F=null),N[3]&&N[0]?T?T.p(N,L):(T=en(N),T.c(),T.m(n,l)):T&&(T.d(1),T=null),N[3]?I?I.p(N,L):(I=nn(N),I.c(),I.m(a,p)):I&&(I.d(1),I=null),L[0]&256&&we(n,"grabbing",N[8]),L[0]&272&&we(n,"can-grab",N[4]!==null&&!N[8]),N[9]?O?O.p(N,L):(O=sn(N),O.c(),O.m(P.parentNode,P)):O&&(O.d(1),O=null)},i:Ct,o:Ct,d(N){N&&(U(n),U(B),U(P)),F&&F.d(),e[59](null),T&&T.d(),I&&I.d(),e[60](null),O&&O.d(N),M=!1,de(X)}}}const on=70,ve=0,Te=500,mt=45,St=45;function rn(e){const{values:n,nFreqs:t,nTimes:s}=e;if(s<=0||t<=0||!n||n.length===0)return console.warn("Invalid spectrogram data:",{nTimes:s,nFreqs:t,valuesLength:n==null?void 0:n.length}),null;const r=new ImageData(s,t);let l=-1/0;for(let h=0;h<n.length;h++)n[h]>l&&(l=n[h]);const a=10*Math.log10(l+1e-10);for(let h=0;h<s;h++)for(let m=0;m<t;m++){const w=n[m*s+h],x=10*Math.log10(w+1e-10),p=Math.max(0,Math.min(1,(x-(a-on))/on)),c=Math.round(255*(1-p)),k=((t-1-m)*s+h)*4;r.data[k]=c,r.data[k+1]=c,r.data[k+2]=c,r.data[k+3]=255}const u=document.createElement("canvas");return u.width=s,u.height=t,u.getContext("2d").putImageData(r,0,0),{imageData:r,canvas:u}}function Cs(e,n,t){let s,r,l,a,u,d,h,m,w,x,p,c,k,B,P,M,X,F,T,I,O;nt(e,Ht,i=>t(71,m=i)),nt(e,Vt,i=>t(44,w=i)),nt(e,Lt,i=>t(3,x=i)),nt(e,xt,i=>t(45,p=i)),nt(e,pe,i=>t(11,c=i)),nt(e,be,i=>t(4,k=i)),nt(e,Kt,i=>t(46,B=i)),nt(e,re,i=>t(47,P=i)),nt(e,Xe,i=>t(72,M=i)),nt(e,Ft,i=>t(48,X=i)),nt(e,Bt,i=>t(49,F=i)),nt(e,se,i=>t(50,T=i)),nt(e,xe,i=>t(51,I=i)),nt(e,un,i=>t(52,O=i));let{showPitch:N=!0}=n,{showFormants:L=!0}=n,{showIntensity:ot=!1}=n,{showHNR:V=!1}=n,{showCoG:It=!1}=n,{showSpectralTilt:Dt=!1}=n,{showA1P0:D=!1}=n,{showNMR:tt=!1}=n,{showDataPoints:G=!0}=n,{maxFreq:W=5e3}=n,st,Q,o=null,H=0,q=0,vt,ft=null,ie=null,rt=null,_t=!1,Z=null,R=null,it=null,Y=!1,ht=0,gt=!1,Pt=null,Tt=null,At=null;function Qt(i,f){it&&clearTimeout(it);const g=f-i;if(r&&!ft){if(g>Gt){t(1,Z=null),R=null;return}if(R&&(Math.min(f,R.end)-Math.max(i,R.start))/g>.9)return;it=setTimeout(async()=>{await ps(i,f),Je(i,f)},300);return}if(!ft)return;if((ft.timeMax-ft.timeMin)/g<2){t(1,Z=null),R=null;return}R&&(Math.min(f,R.end)-Math.max(i,R.start))/g>.9||(it=setTimeout(()=>{Je(i,f)},300))}async function Je(i,f){if(!w||!T||!ft&&!r)return;const g=Pe(),_=(f-i)*.05,y=Math.max(0,i-_),v=Math.min(w.length/m,f+_),b=Math.floor(y*m),S=Math.ceil(v*m),A=w.slice(b,S),E=new g.Sound(A,m);try{const j=Math.max(.001,(v-y)/(u*2)),et=ke(E,.005,W,j,20),J=Ne(et),qt={values:J.values,freqMin:J.freqMin,freqMax:J.freqMax,timeMin:y,timeMax:v,nFreqs:J.nFreqs,nTimes:J.nTimes},kt=rn(qt);kt&&(Z&&(t(1,Z.width=0,Z),t(1,Z.height=0,Z)),t(1,Z=kt.canvas),R={start:y,end:v}),et.free(),ge()}finally{E.free()}}Oe(()=>{t(36,o=Q.getContext("2d")),vt=new ResizeObserver(i=>{const f=i[0].contentRect;t(37,H=f.width),q=f.height,t(6,Q.width=H*devicePixelRatio,Q),t(6,Q.height=q*devicePixelRatio,Q),o&&o.scale(devicePixelRatio,devicePixelRatio),ge()}),vt.observe(st)}),Le(()=>{vt==null||vt.disconnect(),it&&clearTimeout(it)});async function Nn(){if(!w||!T)return;t(7,_t=!0),await Qe();const i=Pe(),f=new i.Sound(w,m);try{const g=ke(f,.005,W,.002,20),_=Ne(g);t(0,ft={values:_.values,freqMin:_.freqMin,freqMax:_.freqMax,timeMin:_.timeMin,timeMax:_.timeMax,nFreqs:_.nFreqs,nTimes:_.nTimes}),t(39,At=W),t(1,Z=null),R=null;const y=rn(ft);y&&(rt&&(t(38,rt.width=0,rt),t(38,rt.height=0,rt)),ie=y.imageData,t(38,rt=y.canvas)),g.free(),await Qe();const v=()=>{H>0&&o?ge():requestAnimationFrame(v)};requestAnimationFrame(v)}finally{f.free(),t(7,_t=!1)}}function ge(){if(!o||H===0)return;const{start:i,end:f}=p,g=M.colors;t(36,o.fillStyle=getComputedStyle(st).getPropertyValue("--color-bg").trim()||"#1a1a1a",o),o.fillRect(0,0,H,q),t(36,o.fillStyle=getComputedStyle(st).getPropertyValue("--color-surface").trim()||"#2a2a2a",o),o.fillRect(0,0,mt,q),o.fillRect(H-St,0,St,q);const _=Z&&R&&i>=R.start&&f<=R.end;if(l&&!_)t(36,o.fillStyle="rgba(255, 255, 255, 0.6)",o),t(36,o.font="14px sans-serif",o),t(36,o.textAlign="center",o),t(36,o.textBaseline="middle",o),o.fillText("Zoom in for spectrogram",mt+u/2,q/2);else if(_&&Z&&R){const b=Z,S=R.start,A=R.end,E=b.width,j=b.height,et=Math.floor((i-S)/(A-S)*E),J=Math.ceil((f-i)/(A-S)*E);t(36,o.imageSmoothingEnabled=!0,o),o.drawImage(b,Math.max(0,et),0,Math.min(J,E-et),j,mt,0,u,q)}else if(ft&&rt){const{timeMin:b,timeMax:S,nTimes:A,nFreqs:E,freqMax:j}=ft,et=Math.floor((i-b)/(S-b)*A),J=Math.ceil((f-i)/(S-b)*A),qt=Math.min(1,W/j),kt=Math.floor(E*qt),$t=E-kt;t(36,o.imageSmoothingEnabled=!1,o),o.drawImage(rt,Math.max(0,et),$t,Math.min(J,A-et),kt,mt,0,u,q)}if(x){const b=Math.max(x.start,i),S=Math.min(x.end,f);if(S>b){const A=yt(b,i,f),E=yt(S,i,f);t(36,o.fillStyle=g.selection.fill,o),o.fillRect(A,0,E-A,q)}}if(F!==null){const b=yt(F,i,f);b>=mt&&b<=d&&(t(36,o.strokeStyle=g.cursor,o),t(36,o.lineWidth=1,o),o.setLineDash([4,4]),o.beginPath(),o.moveTo(b,0),o.lineTo(b,q),o.stroke(),o.setLineDash([]))}const v=yt(X,i,f);v>=mt&&v<=d&&(t(36,o.strokeStyle=g.cursor,o),t(36,o.lineWidth=g.cursorWidth,o),o.beginPath(),o.moveTo(v,0),o.lineTo(v,q),o.stroke()),P&&(N&&Rn(i,f),L&&Cn(i,f),ot&&Fn(i,f),V&&In(i,f),It&&qn(i,f),Dt&&zn(i,f),D&&En(i,f),tt&&Bn(i,f)),G&&Wn(i,f),Dn(),N&&An()}function Dn(){if(!o)return;t(36,o.fillStyle="rgba(255, 255, 255, 0.8)",o),t(36,o.font="10px sans-serif",o),t(36,o.textAlign="right",o);const i=W<=5e3?1e3:W<=7500?1500:2e3;for(let f=0;f<=W;f+=i){const g=q-f/W*q,_=f>=1e3?`${f/1e3}k`:`${f}`;o.fillText(_,mt-4,g+3),t(36,o.strokeStyle="rgba(255, 255, 255, 0.3)",o),t(36,o.lineWidth=1,o),o.beginPath(),o.moveTo(mt-2,g),o.lineTo(mt,g),o.stroke()}o.save(),o.translate(12,q/2),o.rotate(-Math.PI/2),t(36,o.textAlign="center",o),t(36,o.fillStyle="rgba(255, 255, 255, 0.6)",o),t(36,o.font="9px sans-serif",o),o.fillText("Frequency (Hz)",0,0),o.restore()}function An(){if(!o)return;t(36,o.fillStyle="#60a5fa",o),t(36,o.font="10px sans-serif",o),t(36,o.textAlign="left",o);const i=100;for(let f=0;f<=Te;f+=i){const g=qe(f);o.fillText(`${f}`,H-St+4,g+3),t(36,o.strokeStyle="rgba(96, 165, 250, 0.3)",o),t(36,o.lineWidth=1,o),o.beginPath(),o.moveTo(H-St,g),o.lineTo(H-St+2,g),o.stroke()}o.save(),o.translate(H-8,q/2),o.rotate(Math.PI/2),t(36,o.textAlign="center",o),t(36,o.fillStyle="rgba(96, 165, 250, 0.6)",o),t(36,o.font="9px sans-serif",o),o.fillText("Pitch (Hz)",0,0),o.restore()}function Rn(i,f){if(!o||!P)return;const{times:g,pitch:_}=P,y=M.colors;t(36,o.strokeStyle=y.pitch,o),t(36,o.lineWidth=y.pitchWidth,o),o.beginPath();let v=!1;for(let b=0;b<g.length;b++){const S=g[b],A=_[b];if(S<i||S>f)continue;if(A===null||A<=ve||A>Te){v=!1;continue}const E=yt(S,i,f),j=qe(A);v?o.lineTo(E,j):(o.moveTo(E,j),v=!0)}o.stroke(),t(36,o.fillStyle=y.pitch,o);for(let b=0;b<g.length;b++){const S=g[b],A=_[b];if(S<i||S>f||A===null||A<=ve||A>Te)continue;const E=yt(S,i,f),j=qe(A);o.beginPath(),o.arc(E,j,2,0,Math.PI*2),o.fill()}}function Cn(i,f){if(!o||!P)return;const{times:g,formants:_}=P,y=M.colors.formant,v=[y.f1,y.f2,y.f3,y.f4],b=[_.f1,_.f2,_.f3,_.f4];for(let S=0;S<4;S++){const A=b[S];t(36,o.fillStyle=v[S],o);for(let E=0;E<g.length;E++){const j=g[E],et=A[E];if(j<i||j>f||et===null||et>W)continue;const J=yt(j,i,f),qt=Ie(et);o.beginPath(),o.arc(J,qt,y.size,0,Math.PI*2),o.fill()}}}function Fn(i,f){if(!o||!P)return;const{times:g,intensity:_}=P;t(36,o.strokeStyle="#4ade80",o),t(36,o.lineWidth=2,o),o.beginPath();let y=!1;const v=30,b=90;for(let S=0;S<g.length;S++){const A=g[S],E=_[S];if(A<i||A>f)continue;if(E===null){y=!1;continue}const j=yt(A,i,f),et=(E-v)/(b-v),J=q-et*q*.8-q*.1;y?o.lineTo(j,J):(o.moveTo(j,J),y=!0)}o.stroke()}function In(i,f){if(!o||!P)return;const{times:g,harmonicity:_}=P;t(36,o.strokeStyle="#fbbf24",o),t(36,o.lineWidth=2,o),o.beginPath();let y=!1;const v=-10,b=40;for(let S=0;S<g.length;S++){const A=g[S],E=_[S];if(A<i||A>f)continue;if(E===null){y=!1;continue}const j=yt(A,i,f),et=(E-v)/(b-v),J=q-et*q*.8-q*.1;y?o.lineTo(j,J):(o.moveTo(j,J),y=!0)}o.stroke()}function qn(i,f){if(!o||!P||!P.cog)return;const{times:g,cog:_}=P;t(36,o.fillStyle="#c084fc",o);for(let y=0;y<g.length;y++){const v=g[y],b=_[y];if(v<i||v>f||b===null||b>W)continue;const S=yt(v,i,f),A=Ie(b);o.beginPath(),o.arc(S,A,2.5,0,Math.PI*2),o.fill()}}function zn(i,f){if(!o||!P||!P.spectralTilt)return;const{times:g,spectralTilt:_}=P;t(36,o.strokeStyle="#22d3ee",o),t(36,o.lineWidth=2,o),o.beginPath();let y=!1;const v=0,b=40;for(let S=0;S<g.length;S++){const A=g[S],E=_[S];if(A<i||A>f)continue;if(E===null){y=!1;continue}const j=yt(A,i,f),et=(E-v)/(b-v),J=q-et*q*.8-q*.1;y?o.lineTo(j,J):(o.moveTo(j,J),y=!0)}o.stroke()}function En(i,f){if(!o||!P||!P.a1p0)return;const{times:g,a1p0:_}=P;t(36,o.strokeStyle="#fb7185",o),t(36,o.lineWidth=2,o),o.beginPath();let y=!1;const v=-20,b=20;for(let S=0;S<g.length;S++){const A=g[S],E=_[S];if(A<i||A>f)continue;if(E===null){y=!1;continue}const j=yt(A,i,f),et=(E-v)/(b-v),J=q-et*q*.8-q*.1;y?o.lineTo(j,J):(o.moveTo(j,J),y=!0)}o.stroke()}function Bn(i,f){if(!o||!P||!P.nmr)return;const{times:g,nmr:_}=P;t(36,o.strokeStyle="#a0522d",o),t(36,o.lineWidth=2,o),o.setLineDash([6,3]),o.beginPath();let y=!1;for(let v=0;v<g.length;v++){const b=g[v],S=_[v];if(b<i||b>f)continue;if(S===null){y=!1;continue}const A=yt(b,i,f),E=q-S*q*.8-q*.1;y?o.lineTo(A,E):(o.moveTo(A,E),y=!0)}o.stroke(),o.setLineDash([])}function Wn(i,f){if(!o)return;const g=B;for(const _ of g){if(_.time<i||_.time>f)continue;const y=yt(_.time,i,f),v=Ie(_.frequency),b=k===_.id;t(36,o.strokeStyle=b?"#ff6b6b":"#ffcc00",o),t(36,o.lineWidth=b?2:1,o),o.setLineDash([3,3]),o.beginPath(),o.moveTo(y,0),o.lineTo(y,q),o.stroke(),o.setLineDash([]),t(36,o.fillStyle=b?"#ff6b6b":"#ffcc00",o),o.beginPath(),o.arc(y,v,b?6:4,0,Math.PI*2),o.fill(),t(36,o.strokeStyle="#000",o),t(36,o.lineWidth=1,o),o.beginPath(),o.arc(y,v,b?6:4,0,Math.PI*2),o.stroke(),t(36,o.fillStyle="#ffcc00",o),t(36,o.font="10px sans-serif",o),t(36,o.textAlign="center",o),o.fillText(`P${_.id}`,y,12)}}function Ie(i){return q-i/W*q}function ye(i){return(1-i/q)*W}function qe(i){return q-(i-ve)/(Te-ve)*q}function yt(i,f,g){return mt+(i-f)/(g-f)*u}function le(i,f,g){return u<=0?f:f+(i-mt)/u*(g-f)}function On(i){document.activeElement instanceof HTMLInputElement&&document.activeElement.blur();const f=Q.getBoundingClientRect(),g=i.clientX-f.left,_=i.clientY-f.top;if(g<mt||g>H-St)return;const y=le(g,p.start,p.end),v=ye(_);if(G){const b=Me(y,v,.02,W*.05);if(b){Zt(),t(8,gt=!0),Pt=b.id,xe.set(b.id);return}}Y=!0,ht=y,Ft.set(y),Lt.set(null)}function Ln(i){const f=Q.getBoundingClientRect(),g=i.clientX-f.left,_=i.clientY-f.top;if(g<mt||g>H-St){Bt.set(null),gt||be.set(null);return}const y=le(g,p.start,p.end),v=ye(_);if(Bt.set(y),gt&&Pt!==null){Ps(Pt,y,v);return}if(G){const b=Me(y,v,.02,W*.05);be.set((b==null?void 0:b.id)??null)}Y&&(Math.abs(y-ht)>.001&&Lt.set({start:Math.min(ht,y),end:Math.max(ht,y)}),Ft.set(y))}function Vn(){gt&&(t(8,gt=!1),Pt=null,xe.set(null)),Y=!1}function Hn(){gt&&(t(8,gt=!1),Pt=null,xe.set(null)),Y=!1,Bt.set(null),be.set(null)}function Xn(i){if(!G)return;const f=Q.getBoundingClientRect(),g=i.clientX-f.left,_=i.clientY-f.top;if(g<mt||g>H-St)return;const y=le(g,p.start,p.end),v=ye(_);Me(y,v,.02,W*.05)||Pn(y,v)}function Gn(i){if(!G)return;const f=Q.getBoundingClientRect(),g=i.clientX-f.left,_=i.clientY-f.top;if(g<mt||g>H-St)return;const y=le(g,p.start,p.end),v=ye(_),b=Me(y,v,.02,W*.05);b&&(i.preventDefault(),t(9,Tt={x:i.clientX,y:i.clientY,pointId:b.id}))}function Ze(){t(9,Tt=null)}function jn(){Tt&&(_s(Tt.pointId),t(9,Tt=null))}function Un(i){i.preventDefault();const f=Q.getBoundingClientRect(),g=i.clientX-f.left,_=le(g,p.start,p.end),y=w?w.length/m:10,{start:v,end:b}=p,S=b-v;if(Math.abs(i.deltaX)>Math.abs(i.deltaY)){const qt=i.deltaX/u*S;let kt=v+qt,$t=b+qt;kt<0&&(kt=0,$t=S),$t>y&&($t=y,kt=y-S),xt.set({start:kt,end:$t});return}const A=i.deltaY>0?1.1:.91,E=Math.max(.01,Math.min(y,S*A)),j=(_-v)/S,et=Math.max(0,_-j*E),J=Math.min(y,et+E);xt.set({start:Math.max(0,J-E),end:J})}function Yn(){x&&(c?Ae():Ge(x.start,x.end))}function Jn(){const i=w?w.length/m:10,{start:f,end:g}=p,_=g-f,y=(f+g)/2,v=Math.max(.01,_*.7),b=Math.max(0,y-v/2),S=Math.min(i,b+v);xt.set({start:Math.max(0,S-v),end:S})}function Zn(){const i=w?w.length/m:10,{start:f,end:g}=p,_=g-f,y=(f+g)/2,v=Math.min(i,_*1.4),b=Math.max(0,y-v/2),S=Math.min(i,b+v);xt.set({start:Math.max(0,S-v),end:S})}function Kn(){if(!x)return;const i=(x.end-x.start)*.1,f=w?w.length/m:10;xt.set({start:Math.max(0,x.start-i),end:Math.min(f,x.end+i)})}function Qn(){const i=w?w.length/m:10;xt.set({start:0,end:i})}function $n(i){ae.call(this,e,i)}function ts(i){ae.call(this,e,i)}function es(i){ae.call(this,e,i)}function ns(i){ae.call(this,e,i)}function ss(i){ae.call(this,e,i)}const os=i=>i.key==="Escape"&&Tt&&Ze();function rs(i){oe[i?"unshift":"push"](()=>{Q=i,t(6,Q)})}function is(i){oe[i?"unshift":"push"](()=>{st=i,t(5,st)})}return e.$$set=i=>{"showPitch"in i&&t(26,N=i.showPitch),"showFormants"in i&&t(27,L=i.showFormants),"showIntensity"in i&&t(28,ot=i.showIntensity),"showHNR"in i&&t(29,V=i.showHNR),"showCoG"in i&&t(30,It=i.showCoG),"showSpectralTilt"in i&&t(31,Dt=i.showSpectralTilt),"showA1P0"in i&&t(32,D=i.showA1P0),"showNMR"in i&&t(33,tt=i.showNMR),"showDataPoints"in i&&t(34,G=i.showDataPoints),"maxFreq"in i&&t(35,W=i.maxFreq)},e.$$.update=()=>{e.$$.dirty[1]&16384&&t(43,s=p.end-p.start),e.$$.dirty[1]&2097152&&t(41,r=O>Gt),e.$$.dirty[1]&5120&&t(2,l=r&&s>Gt),e.$$.dirty[0]&1|e.$$.dirty[1]&533776&&w&&T&&!r&&(!ft||W!==At)&&Nn(),e.$$.dirty[0]&2080374814|e.$$.dirty[1]&1556735&&t(42,a=[o,rt,Z,H,p,x,X,F,P,B,k,I,W,N,L,ot,V,It,Dt,D,tt,G,l]),e.$$.dirty[0]&6|e.$$.dirty[1]&2272&&a&&o&&H>0&&(rt||l||Z)&&ge(),e.$$.dirty[1]&64&&t(40,u=Math.max(0,H-mt-St)),e.$$.dirty[0]&1|e.$$.dirty[1]&550400&&p&&w&&T&&u>0&&(ft||r)&&Qt(p.start,p.end),e.$$.dirty[1]&64&&(d=H-St),e.$$.dirty[0]&8|e.$$.dirty[1]&16448&&t(10,h=x&&H>0?yt(Math.max(x.start,p.start),p.start,p.end):0)},[ft,Z,l,x,k,st,Q,_t,gt,Tt,h,c,On,Ln,Vn,Hn,Xn,Gn,Ze,jn,Un,Yn,Jn,Zn,Kn,Qn,N,L,ot,V,It,Dt,D,tt,G,W,o,H,rt,At,u,r,a,s,w,p,B,P,X,F,T,I,O,$n,ts,es,ns,ss,os,rs,is]}class ao extends Ve{constructor(n){super(),He(this,n,Cs,Rs,We,{showPitch:26,showFormants:27,showIntensity:28,showHNR:29,showCoG:30,showSpectralTilt:31,showA1P0:32,showNMR:33,showDataPoints:34,maxFreq:35},null,[-1,-1,-1])}}function Fs(e){let n,t;return{c(){n=pt("div"),t=pt("canvas"),this.h()},l(s){n=dt(s,"DIV",{class:!0});var r=wt(n);t=dt(r,"CANVAS",{class:!0}),wt(t).forEach(U),r.forEach(U),this.h()},h(){z(t,"class","svelte-1ubvkuo"),z(n,"class","time-axis svelte-1ubvkuo")},m(s,r){Mt(s,n,r),ct(n,t),e[5](t),e[6](n)},p:Ct,i:Ct,o:Ct,d(s){s&&U(n),e[5](null),e[6](null)}}}let ln=24;function Is(e,n){if(n>=60){const t=Math.floor(e/60),s=Math.floor(e%60);return`${t}:${s.toString().padStart(2,"0")}`}else return n>=1?e.toFixed(0)+"s":n>=.1?e.toFixed(1):n>=.01?e.toFixed(2):e.toFixed(3)}function qs(e,n,t){let s;nt(e,xt,x=>t(4,s=x));let r,l,a=null,u=0,d;Oe(()=>{t(2,a=l.getContext("2d")),d=new ResizeObserver(x=>{const p=x[0].contentRect;t(3,u=p.width),t(1,l.width=u*devicePixelRatio,l),t(1,l.height=ln*devicePixelRatio,l),a&&a.scale(devicePixelRatio,devicePixelRatio),h()}),d.observe(r)}),Le(()=>{d==null||d.disconnect()});function h(){if(!a||u===0)return;const{start:x,end:p}=s,c=p-x;t(2,a.fillStyle="#2d2d2d",a),a.fillRect(0,0,u,ln);const k=Math.floor(u/80),B=c/k;let M=[.001,.002,.005,.01,.02,.05,.1,.2,.5,1,2,5,10,30,60].find(T=>T>=B)||60;t(2,a.strokeStyle="#606060",a),t(2,a.fillStyle="#a0a0a0",a),t(2,a.font="10px sans-serif",a),t(2,a.textAlign="center",a);const X=Math.ceil(x/M)*M;for(let T=X;T<=p;T+=M){const I=(T-x)/c*u;a.beginPath(),a.moveTo(I,0),a.lineTo(I,6),a.stroke();const O=Is(T,M);a.fillText(O,I,18)}const F=M/5;if(F>=.001){t(2,a.strokeStyle="#404040",a);const T=Math.ceil(x/F)*F;for(let I=T;I<=p;I+=F){const O=(I-x)/c*u;a.beginPath(),a.moveTo(O,0),a.lineTo(O,3),a.stroke()}}}function m(x){oe[x?"unshift":"push"](()=>{l=x,t(1,l)})}function w(x){oe[x?"unshift":"push"](()=>{r=x,t(0,r)})}return e.$$.update=()=>{e.$$.dirty&28&&a&&u>0&&s&&h()},[r,l,a,u,s,m,w]}class co extends Ve{constructor(n){super(),He(this,n,qs,Fs,We,{})}}export{Js as A,Zs as B,ro as C,Ks as D,Qs as E,Ss as F,to as G,$s as H,ut as I,Us as J,io as K,lo as L,ue as M,Kt as N,Ys as O,ao as S,co as T,Vs as W,Vt as a,Ft as b,Gs as c,un as d,Lt as e,Ls as f,re as g,pe as h,Hs as i,De as j,lt as k,Ae as l,Ge as m,Yt as n,Zt as o,js as p,no as q,Xs as r,Ht as s,xt as t,Bt as u,oo as v,se as w,Ts as x,eo as y,so as z};
