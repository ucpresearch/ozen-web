import{s as We,n as Dt,d as j,r as de,i as xt,b as ut,E as $,B as z,c as mt,e as gt,h as dt,k as st,w as Oe,G as Le,D as oe,v as C,I as we,_ as kt,g as It,H as ne,x as Ze,j as qt,C as ee,a1 as ae,N as fe,O as he,z as Ke}from"./DzR6qLkJ.js";import{S as He,i as Ve}from"./CbSE4UIZ.js";import{c as Xe,g as ln}from"./BmAGY9Gp.js";import{w as tt,d as an}from"./azyml33n.js";import{b as rs}from"./BvRoC4Yh.js";const Ot=tt(null),Lt=tt(44100),Ws=tt(""),cn=tt(0),bt=tt({start:0,end:5}),Ct=tt(0),Wt=tt(null),zt=tt(null);an(bt,e=>e.end-e.start);function is(e){let n,t,s,r;return{c(){n=dt("div"),t=dt("canvas"),this.h()},l(l){n=mt(l,"DIV",{class:!0,role:!0,"aria-label":!0});var a=gt(n);t=mt(a,"CANVAS",{class:!0}),gt(t).forEach(j),a.forEach(j),this.h()},h(){z(t,"class","svelte-vdkqpy"),z(n,"class","waveform-container svelte-vdkqpy"),z(n,"role","application"),z(n,"aria-label","Audio waveform - click and drag to select, scroll to zoom")},m(l,a){xt(l,n,a),ut(n,t),e[14](t),e[15](n),s||(r=[$(n,"mousedown",e[2]),$(n,"mousemove",e[3]),$(n,"mouseup",e[4]),$(n,"mouseleave",e[5]),$(n,"wheel",e[6])],s=!0)},p:Dt,i:Dt,o:Dt,d(l){l&&j(n),e[14](null),e[15](null),s=!1,de(r)}}}const wt=45,te=45;function ls(e,n,t){let s,r,l,a,u,d,f,m,w;st(e,bt,N=>t(9,l=N)),st(e,Lt,N=>t(22,a=N)),st(e,Ot,N=>t(10,u=N)),st(e,Ct,N=>t(11,d=N)),st(e,zt,N=>t(12,f=N)),st(e,Wt,N=>t(13,m=N)),st(e,Xe,N=>t(23,w=N));let x,p,c=null,k=0,q=0,_,M=!1,V=0;Oe(()=>{t(7,c=p.getContext("2d")),_=new ResizeObserver(N=>{const U=N[0].contentRect;t(8,k=U.width),q=U.height,t(1,p.width=k*devicePixelRatio,p),t(1,p.height=q*devicePixelRatio,p),c&&c.scale(devicePixelRatio,devicePixelRatio),R()}),_.observe(x)}),Le(()=>{_==null||_.disconnect()});function R(){if(!c||!u||k===0)return;const N=u,U=a,{start:E,end:Q}=l,X=w.colors;if(t(7,c.fillStyle=getComputedStyle(x).getPropertyValue("--color-bg").trim()||"#1a1a1a",c),c.fillRect(0,0,k,q),t(7,c.fillStyle=getComputedStyle(x).getPropertyValue("--color-surface").trim()||"#2a2a2a",c),c.fillRect(0,0,wt,q),c.fillRect(k-te,0,te,q),t(7,c.fillStyle=X.waveform.background,c),c.fillRect(wt,0,s,q),m){const O=Math.max(m.start,E),lt=Math.min(m.end,Q);if(lt>O){const Z=T(O,E,Q),ot=T(lt,E,Q);t(7,c.fillStyle=X.selection.fill,c),c.fillRect(Z,0,ot-Z,q)}}const o=Math.floor(E*U),Y=Math.ceil(Q*U),F=(Y-o)/s;let Mt=0;const it=Y-o,ie=Math.max(1,Math.floor(it/1e3));for(let O=Math.max(0,o);O<Math.min(Y,N.length);O+=ie){const lt=Math.abs(N[O]);lt>Mt&&(Mt=lt)}const pt=Mt>.01?Math.min(.95/Mt,10):1;t(7,c.strokeStyle=X.waveform.line,c),t(7,c.lineWidth=X.waveform.lineWidth,c);const vt=q/2,et=(q/2-4)*pt;if(c.save(),c.beginPath(),c.rect(wt,0,s,q),c.clip(),F<=1){c.beginPath();for(let O=0;O<s;O++){const lt=Math.floor(o+O*F);if(lt>=0&&lt<N.length){const Z=wt+O,ot=vt-N[lt]*et;O===0?c.moveTo(Z,ot):c.lineTo(Z,ot)}}c.stroke()}else{const O=[],lt=[];for(let Z=0;Z<s;Z++){const ot=Math.floor(o+Z*F),Tt=Math.floor(o+(Z+1)*F);let St=1/0,Ht=-1/0;for(let Vt=ot;Vt<Tt&&Vt<N.length;Vt++)if(Vt>=0){const Xt=N[Vt];Xt<St&&(St=Xt),Xt>Ht&&(Ht=Xt)}St!==1/0?(O.push(St),lt.push(Ht)):(O.push(0),lt.push(0))}t(7,c.fillStyle=X.waveform.line,c),c.beginPath();for(let Z=0;Z<O.length;Z++){const ot=wt+Z,Tt=vt-lt[Z]*et;Z===0?c.moveTo(ot,Tt):c.lineTo(ot,Tt)}for(let Z=O.length-1;Z>=0;Z--){const ot=wt+Z,Tt=vt-O[Z]*et;c.lineTo(ot,Tt)}c.closePath(),c.fill()}if(t(7,c.strokeStyle="rgba(128, 128, 128, 0.3)",c),t(7,c.lineWidth=1,c),c.beginPath(),c.moveTo(wt,vt),c.lineTo(r,vt),c.stroke(),f!==null){const O=T(f,E,Q);O>=wt&&O<=r&&(t(7,c.strokeStyle=X.cursor,c),t(7,c.lineWidth=1,c),c.setLineDash([4,4]),c.beginPath(),c.moveTo(O,0),c.lineTo(O,q),c.stroke(),c.setLineDash([]))}const J=T(d,E,Q);J>=wt&&J<=r&&(t(7,c.strokeStyle=X.cursor,c),t(7,c.lineWidth=X.cursorWidth,c),c.beginPath(),c.moveTo(J,0),c.lineTo(J,q),c.stroke()),c.restore()}function T(N,U,E){return wt+(N-U)/(E-U)*s}function A(N,U,E){return s<=0?U:U+(N-wt)/s*(E-U)}function B(N){document.activeElement instanceof HTMLInputElement&&document.activeElement.blur();const U=p.getBoundingClientRect(),E=N.clientX-U.left;if(E<wt||E>k-te)return;const Q=A(E,l.start,l.end);N.shiftKey||(M=!0,V=Q,Ct.set(Q),Wt.set(null))}function D(N){const U=p.getBoundingClientRect(),E=N.clientX-U.left;if(E<wt||E>k-te){zt.set(null);return}const Q=A(E,l.start,l.end);zt.set(Q),M&&(Math.abs(Q-V)>.001&&Wt.set({start:Math.min(V,Q),end:Math.max(V,Q)}),Ct.set(Q))}function H(){M=!1}function ct(){M=!1,zt.set(null)}function L(N){N.preventDefault();const U=p.getBoundingClientRect(),E=N.clientX-U.left,Q=A(E,l.start,l.end),X=u?u.length/a:10,{start:o,end:Y}=l,F=Y-o;if(Math.abs(N.deltaX)>Math.abs(N.deltaY)){const et=N.deltaX/s*F;let J=o+et,O=Y+et;J<0&&(J=0,O=F),O>X&&(O=X,J=X-F),bt.set({start:J,end:O});return}const Mt=N.deltaY>0?1.1:.91,it=Math.max(.01,Math.min(X,F*Mt)),ie=(Q-o)/F,pt=Math.max(0,Q-ie*it),vt=Math.min(X,pt+it);bt.set({start:Math.max(0,vt-it),end:vt})}function Ft(N){oe[N?"unshift":"push"](()=>{p=N,t(1,p)})}function Nt(N){oe[N?"unshift":"push"](()=>{x=N,t(0,x)})}return e.$$.update=()=>{e.$$.dirty&256&&(s=Math.max(0,k-wt-te)),e.$$.dirty&256&&(r=k-te),e.$$.dirty&16256&&c&&u&&k>0&&l&&m!==void 0&&d!==void 0&&f!==void 0&&R()},[x,p,B,D,H,ct,L,c,k,l,u,d,f,m,Ft,Nt]}class Os extends He{constructor(n){super(),Ve(this,n,ls,is,We,{})}}const se=tt(!1),ue=tt(null);let Gt=null,ce=null;const as={"praatfan-gpl":"https://ucpresearch.github.io/praatfan-core-rs/pkg/praatfan_gpl.js",praatfan:"https://ucpresearch.github.io/praatfan-core-clean/pkg/praatfan.js"};function cs(e){return e==="praatfan-local"?`${rs}/wasm/praatfan/praatfan.js`:as[e]}const us={"praatfan-gpl":"praatfan-gpl",praatfan:"praatfan","praatfan-local":"praatfan"};async function Ls(e="praatfan-local"){C(ue)===e&&Gt||ce&&(await ce,C(ue)===e&&Gt)||(se.set(!1),Gt=null,ce=(async()=>{try{const t=cs(e);console.log(`Loading WASM module from ${t}...`);const s=await import(t);await s.default(),(e==="praatfan"||e==="praatfan-local")&&typeof s.init=="function"&&s.init(),Gt=s,ue.set(e),se.set(!0),console.log(`WASM acoustic analysis module initialized (${e})`)}catch(t){throw Gt=null,ue.set(null),se.set(!1),console.error("Failed to initialize WASM module:",t),t}finally{ce=null}})(),await ce)}function Pe(){if(!Gt)throw new Error("WASM module not initialized. Call initWasm() first.");return Gt}function fs(){const e=C(ue);if(!e)throw new Error("No backend loaded. Call initWasm() first.");return e}function Zt(){const e=fs();return us[e]}function un(e,n,t,s){return Zt()==="praatfan-gpl"?e.to_pitch(n,t,s):e.to_pitch_ac(n,t,s)}function fn(e,n,t){return e.to_intensity(n,t)}function hn(e,n,t,s,r,l){return e.to_formant_burg(n,t,s,r,l)}function mn(e,n,t,s,r){return e.to_harmonicity_ac(n,t,s,r)}function ke(e,n,t,s,r){return Zt()==="praatfan-gpl"?e.to_spectrogram(n,t,s,r,"gaussian"):e.to_spectrogram(n,t,s,r)}function hs(e,n){return e.to_spectrum(n)}function dn(e){return e.times()}function pn(e){return e.values()}function gn(e,n){if(Zt()==="praatfan-gpl")return e.get_value_at_time(n,"cubic");{const s=e.times(),r=e.values();return Re(s,r,n)}}function Et(e,n,t){if(Zt()==="praatfan-gpl")return e.get_value_at_time(n,t,"hertz","linear");{const r=e.times(),l=e.formant_values(n);return Re(r,l,t)}}function Bt(e,n,t){if(Zt()==="praatfan-gpl")return e.get_bandwidth_at_time(n,t,"hertz","linear");{const r=e.times(),l=e.bandwidth_values(n);return Re(r,l,t)}}function yn(e,n){if(Zt()==="praatfan-gpl")return e.get_value_at_time(n,"linear");{const s=e.times(),r=e.values();return Re(s,r,n)}}function Ne(e){return Zt()==="praatfan-gpl"?{values:e.values(),freqMin:e.freq_min,freqMax:e.freq_max,timeMin:e.start_time,timeMax:e.start_time+(e.num_frames-1)*e.time_step,nFreqs:e.num_freq_bins,nTimes:e.num_frames}:{values:e.values(),freqMin:e.freq_min(),freqMax:e.freq_max(),timeMin:e.time_min(),timeMax:e.time_max(),nFreqs:e.n_freqs(),nTimes:e.n_times()}}function Re(e,n,t){if(e.length===0)return NaN;if(e.length===1)return n[0];const s=e.length>1?e[1]-e[0]:1,r=e[0],l=(t-r)/s;if(l<=0)return n[0];if(l>=e.length-1)return n[e.length-1];const a=Math.floor(l),u=a+1,d=l-a,f=n[a],m=n[u];return isNaN(f)&&isNaN(m)?NaN:isNaN(f)?m:isNaN(m)?f:f+d*(m-f)}const Ae=tt(!1),rt=tt(0),re=tt(null),wn=tt({timeStep:.01,pitchFloor:75,pitchCeiling:600,maxFormant:5500,numFormants:5}),jt=60;async function Hs(){const e=C(Ot),n=C(Lt),t=C(se);if(!e||!t){console.warn("Cannot run analysis: audio or WASM not ready");return}const s=C(cn);if(s>jt){console.log(`Audio duration ${s.toFixed(1)}s exceeds ${jt}s limit, skipping analysis`),re.set(null);return}Ae.set(!0),rt.set(0);try{const r=C(wn),l=ln(),a=Pe(),u=new a.Sound(e,n);try{rt.set(10);const d=un(u,r.timeStep,r.pitchFloor,r.pitchCeiling);let f,m,w,x;try{rt.set(25),f=fn(u,r.pitchFloor,r.timeStep),rt.set(40),m=hn(u,r.timeStep,r.numFormants,l.maxFormant,.025,50),rt.set(55),w=mn(u,r.timeStep,r.pitchFloor,.1,4.5),rt.set(70);const p=Array.from(dn(d)),c=Array.from(pn(d));rt.set(75),x=ke(u,.005,5e3,.002,20),rt.set(85);const k=bn(e,n,p,c,a),q=Ne(x);rt.set(95);const _={times:p,pitch:c.map(M=>isNaN(M)||M===0?null:M),intensity:p.map(M=>{const V=gn(f,M);return isNaN(V)?null:V}),formants:{f1:p.map(M=>at(Et(m,1,M))),f2:p.map(M=>at(Et(m,2,M))),f3:p.map(M=>at(Et(m,3,M))),f4:p.map(M=>at(Et(m,4,M))),b1:p.map(M=>at(Bt(m,1,M))),b2:p.map(M=>at(Bt(m,2,M))),b3:p.map(M=>at(Bt(m,3,M))),b4:p.map(M=>at(Bt(m,4,M)))},harmonicity:p.map(M=>at(yn(w,M))),cog:k.cog,spectralTilt:k.spectralTilt,a1p0:k.a1p0,spectrogram:q};rt.set(100),re.set(_)}finally{d.free();try{f==null||f.free()}catch{}try{m==null||m.free()}catch{}try{w==null||w.free()}catch{}try{x==null||x.free()}catch{}}}finally{u.free()}}catch(r){throw console.error("Analysis failed:",r),r}finally{Ae.set(!1)}}function at(e){return isNaN(e)||e===0?null:e}async function ms(e,n){const t=C(Ot),s=C(Lt),r=C(se);if(!t||!r){console.warn("Cannot run analysis: audio or WASM not ready");return}const l=n-e;if(l>jt){console.log(`Range ${l.toFixed(1)}s exceeds ${jt}s limit`);return}Ae.set(!0),rt.set(0);try{const a=C(wn),u=ln(),d=Pe(),f=.1,m=Math.max(0,e-f),w=Math.min(t.length/s,n+f),x=Math.floor(m*s),p=Math.ceil(w*s),c=t.slice(x,p),k=new d.Sound(c,s);try{rt.set(15);const q=un(k,a.timeStep,a.pitchFloor,a.pitchCeiling);let _,M,V,R;try{rt.set(30),_=fn(k,a.pitchFloor,a.timeStep),rt.set(45),M=hn(k,a.timeStep,a.numFormants,u.maxFormant,.025,50),rt.set(60),V=mn(k,a.timeStep,a.pitchFloor,.1,4.5),rt.set(75);const T=Array.from(dn(q)),A=T.map(L=>L+m),B=Array.from(pn(q));rt.set(85),R=ke(k,.005,5e3,.002,20);const D=bn(c,s,T,B,d),H=Ne(R);H.timeMin=m,H.timeMax=w,rt.set(95);const ct={times:A,pitch:B.map(L=>isNaN(L)||L===0?null:L),intensity:A.map((L,Ft)=>{const Nt=gn(_,T[Ft]);return isNaN(Nt)?null:Nt}),formants:{f1:T.map(L=>at(Et(M,1,L))),f2:T.map(L=>at(Et(M,2,L))),f3:T.map(L=>at(Et(M,3,L))),f4:T.map(L=>at(Et(M,4,L))),b1:T.map(L=>at(Bt(M,1,L))),b2:T.map(L=>at(Bt(M,2,L))),b3:T.map(L=>at(Bt(M,3,L))),b4:T.map(L=>at(Bt(M,4,L)))},harmonicity:T.map(L=>at(yn(V,L))),cog:D.cog,spectralTilt:D.spectralTilt,a1p0:D.a1p0,spectrogram:H};rt.set(100),re.set(ct),console.log(`Analysis completed for range ${e.toFixed(1)}s - ${n.toFixed(1)}s`)}finally{q.free();try{_==null||_.free()}catch{}try{M==null||M.free()}catch{}try{V==null||V.free()}catch{}try{R==null||R.free()}catch{}}}finally{k.free()}}catch(a){throw console.error("Range analysis failed:",a),a}finally{Ae.set(!1)}}function bn(e,n,t,s,r){const u=Math.floor(.025*n),d=[],f=[],m=[];for(let w=0;w<t.length;w++){const x=t[w],p=s[w],c=Math.max(0,Math.floor((x-.0125)*n)),k=Math.min(e.length,c+u);if(k-c<u/2){d.push(null),f.push(null),m.push(null);continue}let q=null,_=null;try{const M=e.slice(c,k);q=new r.Sound(M,n),_=hs(q,!0);const V=_.get_center_of_gravity(2);d.push(isNaN(V)||V<=0?null:V);const R=_.get_band_energy(0,500),T=_.get_band_energy(2e3,4e3);if(R>0&&T>0){const A=10*Math.log10(R)-10*Math.log10(T);f.push(isNaN(A)?null:A)}else f.push(null);if(p&&!isNaN(p)&&p>0){const A=_.get_band_energy(p*.9,p*1.1),B=_.get_band_energy(200,300);if(A>0&&B>0){const D=10*Math.log10(A)-10*Math.log10(B);m.push(isNaN(D)?null:D)}else m.push(null)}else m.push(null)}catch{d.push(null),f.push(null),m.push(null)}finally{try{_==null||_.free()}catch{}try{q==null||q.free()}catch{}}}return{cog:d,spectralTilt:f,a1p0:m}}function Vs(){re.set(null),rt.set(0)}const pe=tt(!1),Ee=tt("full");let me=null,At=null,xn=0,Se=0,Be=0,_e=null;function ds(){return me||(me=new AudioContext),me}function ps(){const e=C(Ot),n=C(Lt);if(!e)return;e.length/n;const t=C(Ct),s=C(Wt),r=C(bt);let l,a;s&&s.end>s.start?(l=s.start,a=s.end,Ee.set("selection")):(l=t,a=r.end,Ee.set("visible")),Ge(l,a)}function Ge(e,n){De();const t=C(Ot),s=C(Lt);if(!t)return;const r=ds(),a=Math.ceil(.3*s),u=t.length+a,d=r.createBuffer(1,u,s),f=d.getChannelData(0);for(let m=0;m<t.length;m++)f[m]=t[m];At=r.createBufferSource(),At.buffer=d,At.connect(r.destination),Se=Math.max(0,e),Be=Math.min(t.length/s,n),xn=r.currentTime,At.start(0,Se,Be-Se),pe.set(!0),At.onended=()=>{De()},vn()}function Xs(){const e=C(bt);Ee.set("visible"),Ge(e.start,e.end)}function Mn(){At&&(At.stop(),At.disconnect(),At=null),_e!==null&&(cancelAnimationFrame(_e),_e=null),pe.set(!1)}function De(){Mn();const e=C(Wt);e&&Ct.set(e.start)}function Gs(){C(pe)?Mn():ps()}function vn(){if(!C(pe)||!me)return;const e=me.currentTime-xn,n=Se+e;if(n>=Be){De();return}Ct.set(n),_e=requestAnimationFrame(vn)}function gs(e){const n=e.split(/\r?\n/);let t=0;function s(){for(;t<n.length&&n[t].trim()==="";)t++;return t<n.length?n[t++].trim():""}const r=s();if(!r)throw new Error("Empty or invalid TextGrid file");const l=r==='"ooTextFile"'||!r.includes("=");return t=0,l?ys(n):ws(n)}function ys(e){let n=0;const t=[];function s(){for(;n<e.length&&e[n].trim()==="";)n++;return n<e.length?e[n++].trim():""}function r(){return s().replace(/^"|"$/g,"").replace(/""/g,'"')}function l(){const f=parseFloat(s());if(isNaN(f))throw new Error("Invalid number in TextGrid file");return f}r(),r();const a=l(),u=l();s();const d=l();for(let f=0;f<d;f++){const m=r(),w=r();l(),l();const x=l(),p={name:w,type:m==="IntervalTier"?"interval":"point",intervals:[]};for(let c=0;c<x;c++)if(p.type==="interval"){const k=l(),q=l(),_=r();p.intervals.push({start:k,end:q,text:_})}else{const k=l(),q=r();p.intervals.push({start:k,end:k,text:q})}t.push(p)}return{tiers:t,xmin:a,xmax:u}}function ws(e){let n=0;const t=[];function s(){for(;n<e.length&&e[n].trim()==="";)n++;return n<e.length?e[n++].trim():""}function r(f){const m=f.match(/=\s*(.+)$/);return m?m[1].trim():f.trim()}function l(f){const m=parseFloat(r(f));if(isNaN(m))throw new Error(`Invalid number in TextGrid file: ${f}`);return m}function a(f){return r(f).replace(/^"|"$/g,"").replace(/""/g,'"')}s(),s();let u=0,d=0;for(;n<e.length;){const f=s();if(f.startsWith("xmin"))u=l(f);else if(f.startsWith("xmax"))d=l(f);else if(f.includes("size =")){const m=l(f);s();for(let w=0;w<m;w++){s();const x=s(),p=a(x),c=s(),k=a(c),q=s();l(q);const _=s();l(_);const M=s(),V=l(M),R={name:k,type:p==="IntervalTier"?"interval":"point",intervals:[]};for(let T=0;T<V;T++)if(s(),R.type==="interval"){const A=l(s()),B=l(s()),D=a(s());R.intervals.push({start:A,end:B,text:D})}else{const A=l(s()),B=a(s());R.intervals.push({start:A,end:A,text:B})}t.push(R)}break}}return{tiers:t,xmin:u,xmax:d}}function bs(e,n,t){const s=[];s.push('File type = "ooTextFile"'),s.push('Object class = "TextGrid"'),s.push(""),s.push(`xmin = ${n}`),s.push(`xmax = ${t}`),s.push("tiers? <exists>"),s.push(`size = ${e.length}`),s.push("item []:");for(let r=0;r<e.length;r++){const l=e[r];s.push(`    item [${r+1}]:`),s.push(`        class = "${l.type==="interval"?"IntervalTier":"TextTier"}"`),s.push(`        name = "${ze(l.name)}"`);const a=l.intervals.length>0?l.intervals[0].start:n,u=l.intervals.length>0?l.intervals[l.intervals.length-1].end:t;if(s.push(`        xmin = ${a}`),s.push(`        xmax = ${u}`),l.type==="interval"){s.push(`        intervals: size = ${l.intervals.length}`);for(let d=0;d<l.intervals.length;d++){const f=l.intervals[d];s.push(`        intervals [${d+1}]:`),s.push(`            xmin = ${f.start}`),s.push(`            xmax = ${f.end}`),s.push(`            text = "${ze(f.text)}"`)}}else{s.push(`        points: size = ${l.intervals.length}`);for(let d=0;d<l.intervals.length;d++){const f=l.intervals[d];s.push(`        points [${d+1}]:`),s.push(`            number = ${f.start}`),s.push(`            mark = "${ze(f.text)}"`)}}}return s.join(`
`)}function ze(e){return e.replace(/"/g,'""')}const xs=50,Ce=tt([]),Fe=tt([]);let Ut=null,Yt=null;function je(){if(!Ut)return[];let e=[];return Ut.subscribe(t=>{e=t})(),e}function Ue(){if(!Yt)return[];let e=[];return Yt.subscribe(t=>{e=t})(),e}function js(e,n){Ut=e,Yt=n}function Kt(){const e={tiers:JSON.parse(JSON.stringify(je())),dataPoints:JSON.parse(JSON.stringify(Ue()))};Ce.update(n=>{const t=[...n,e];return t.length>xs&&t.shift(),t}),Fe.set([])}function Us(){const e=C(Ce);if(e.length===0)return!1;const n={tiers:JSON.parse(JSON.stringify(je())),dataPoints:JSON.parse(JSON.stringify(Ue()))};Fe.update(s=>[...s,n]);const t=e[e.length-1];return Ce.update(s=>s.slice(0,-1)),Ut&&Ut.set(t.tiers),Yt&&Yt.set(t.dataPoints),!0}function Ys(){const e=C(Fe);if(e.length===0)return!1;const n={tiers:JSON.parse(JSON.stringify(je())),dataPoints:JSON.parse(JSON.stringify(Ue()))};Ce.update(s=>[...s,n]);const t=e[e.length-1];return Fe.update(s=>s.slice(0,-1)),Ut&&Ut.set(t.tiers),Yt&&Yt.set(t.dataPoints),!0}const ft=tt([]),Jt=tt(0);an([ft,Jt],([e,n])=>e[n]||null);const Ms=tt(null);function Js(e){try{const{tiers:n}=gs(e);Kt(),ft.set(n),Jt.set(0),Ms.set(null)}catch(n){throw console.error("Failed to parse TextGrid:",n),n}}function Zs(){const e=C(Ot),n=C(Lt),t=e?e.length/n:1;return bs(C(ft),0,t)}function vs(e,n="interval"){const t=C(Ot),s=C(Lt),r=t?t.length/s:1,l={name:e,type:n,intervals:n==="interval"?[{start:0,end:r,text:""}]:[]};ft.update(a=>[...a,l])}function Ks(e){ft.update(t=>t.filter((s,r)=>r!==e));const n=C(Jt);n>=e&&n>0&&Jt.update(t=>t-1)}function Qs(e,n){ft.update(t=>t.map((s,r)=>r===e?{...s,name:n}:s))}const Qe=.05;function Tn(e,n,t){for(let s=0;s<n;s++){const r=t[s];if(r.type==="interval")for(const l of r.intervals){if(Math.abs(l.start-e)<=Qe)return l.start;if(Math.abs(l.end-e)<=Qe)return l.end}}return null}function $s(e){const n=C(Jt),t=C(ft);if(n<0||n>=t.length)return;const s=t[n];if(s.type!=="interval")return;const r=Tn(e,n,t),l=r!==null?r:e,a=s.intervals.findIndex(m=>l>m.start&&l<m.end);if(a===-1)return;Kt();const u=s.intervals[a],d={start:u.start,end:l,text:u.text},f={start:l,end:u.end,text:""};ft.update(m=>{const w=[...m];return w[n]={...w[n],intervals:[...w[n].intervals.slice(0,a),d,f,...w[n].intervals.slice(a+1)]},w})}function to(e){const n=C(Jt),t=C(ft);if(n<0||n>=t.length||e<=0)return;const s=t[n];s.type==="interval"&&(e>=s.intervals.length||(Kt(),ft.update(r=>{const l=[...r],a=[...l[n].intervals],u=a[e-1],d=a[e],f={start:u.start,end:d.end,text:u.text||d.text};return a.splice(e-1,2,f),l[n]={...l[n],intervals:a},l})))}function eo(e,n,t){const s=C(ft);if(e<s.length&&n<s[e].intervals.length){if(s[e].intervals[n].text===t)return;Kt()}ft.update(r=>{const l=[...r];return e<l.length&&n<l[e].intervals.length&&(l[e]={...l[e],intervals:l[e].intervals.map((a,u)=>u===n?{...a,text:t}:a)}),l})}function no(e,n){const t=C(Jt),s=C(ft);if(t<0||t>=s.length||e<=0)return;const r=s[t];if(e>=r.intervals.length)return;const l=r.intervals[e-1],a=r.intervals[e],u=Tn(n,t,s),d=u!==null?u:n;d<=l.start||d>=a.end||ft.update(f=>{const m=[...f],w=[...m[t].intervals];return w[e-1]={...w[e-1],end:d},w[e]={...w[e],start:d},m[t]={...m[t],intervals:w},m})}function so(){if(C(ft).length===0){const n=C(Xe);for(const t of n.annotation.defaultTiers)vs(t)}}const Qt=tt([]),be=tt(null),xe=tt(null);let Sn=1;function _n(e,n){Kt();const t=Pn(e),s=Ye(e),r={id:Sn++,time:e,frequency:n,acousticValues:t,annotationIntervals:s};return Qt.update(l=>[...l,r]),r}function Ts(e){Kt();let n=null;return Qt.update(t=>{const s=t.findIndex(r=>r.id===e);return s!==-1?(n=t[s],[...t.slice(0,s),...t.slice(s+1)]):t}),n}function Ss(e,n,t){let s=!1;return Qt.update(r=>r.map(l=>{if(l.id===e){s=!0;const a=Pn(n),u=Ye(n);return{...l,time:n,frequency:t,acousticValues:a,annotationIntervals:u}}return l})),s}function Me(e,n,t=.02,s=100){const r=C(Qt);let l=null,a=1/0;for(const u of r){const d=Math.abs(u.time-e),f=Math.abs(u.frequency-n);if(d<=t&&f<=s){const m=(d/t)**2+(f/s)**2;m<a&&(a=m,l=u)}}return l}function _s(){Qt.set([]),Sn=1}function Pn(e){const n=C(re);if(!n)return{};const{times:t}=n;if(!t||t.length===0)return{};let s=0,r=1/0;for(let l=0;l<t.length;l++){const a=Math.abs(t[l]-e);a<r&&(r=a,s=l)}return{Pitch:n.pitch[s],Intensity:n.intensity[s],F1:n.formants.f1[s],F2:n.formants.f2[s],F3:n.formants.f3[s],F4:n.formants.f4[s],B1:n.formants.b1[s],B2:n.formants.b2[s],B3:n.formants.b3[s],B4:n.formants.b4[s],HNR:n.harmonicity[s],CoG:n.cog[s],SpectralTilt:n.spectralTilt[s],"A1-P0":n.a1p0[s]}}function Ye(e){const n=C(ft),t={};for(const s of n)for(const r of s.intervals)if(e>=r.start&&e<r.end){t[s.name]=r.text;break}return t}function Ps(e,n){if(!n)return e;const t=[];for(const s of e){const r=s.toLowerCase();r==="pitch"||r==="f0"?n.showPitch&&t.push(s):r.startsWith("f")&&/^f[1-4]$/.test(r)||r.startsWith("b")&&/^b[1-4]$/.test(r)?n.showFormants&&t.push(s):r==="intensity"?n.showIntensity&&t.push(s):r==="hnr"||r==="harmonicity"?n.showHNR&&t.push(s):r==="cog"||r==="centerofgravity"?n.showCoG&&t.push(s):r==="spectraltilt"||r==="tilt"?n.showSpectralTilt&&t.push(s):r==="a1p0"||r==="a1-p0"?n.showA1P0&&t.push(s):t.push(s)}return t}function oo(e){const n=C(Qt),t=C(ft);if(n.length===0)return`time	frequency
`;const s=new Set;for(const w of n)Object.keys(w.acousticValues).forEach(x=>s.add(x));const r=Array.from(s).sort(),l=Ps(r,e),a=t.map(w=>w.name),u=["time","frequency",...l,...a],f=[...n].sort((w,x)=>w.time-x.time).map(w=>{const x=[w.time.toFixed(4),w.frequency.toFixed(1)];for(const c of l){const k=w.acousticValues[c];x.push(k!=null?k.toFixed(2):"")}const p=Ye(w.time);for(const c of a)x.push(p[c]||"");return x});return[u.join("	"),...f.map(w=>w.join("	"))].join(`
`)}function ro(e){const n=e.trim().split(`
`);if(n.length<2)return-1;const t=n[0].split("	").map(a=>a.trim().toLowerCase()),s=t.indexOf("time"),r=t.indexOf("frequency");if(s===-1||r===-1)return-1;_s();let l=0;for(let a=1;a<n.length;a++){const u=n[a].trim();if(!u)continue;const d=u.split("	"),f=parseFloat(d[s]),m=parseFloat(d[r]);!isNaN(f)&&!isNaN(m)&&(_n(f,m),l++)}return l}function $e(e){let n,t="Computing spectrogram...";return{c(){n=dt("div"),n.textContent=t,this.h()},l(s){n=mt(s,"DIV",{class:!0,"data-svelte-h":!0}),ne(n)!=="svelte-vvjva"&&(n.textContent=t),this.h()},h(){z(n,"class","computing svelte-1r84lea")},m(s,r){xt(s,n,r)},d(s){s&&j(n)}}}function tn(e){let n,t,s;function r(u,d){return u[11]?Ns:ks}let l=r(e),a=l(e);return{c(){n=dt("button"),a.c(),this.h()},l(u){n=mt(u,"BUTTON",{class:!0,style:!0,title:!0});var d=gt(n);a.l(d),d.forEach(j),this.h()},h(){z(n,"class","play-selection-btn svelte-1r84lea"),ee(n,"left",e[10]+4+"px"),z(n,"title","Play selection")},m(u,d){xt(u,n,d),a.m(n,null),t||(s=[$(n,"mousedown",kt(e[56])),$(n,"click",kt(e[21]))],t=!0)},p(u,d){l!==(l=r(u))&&(a.d(1),a=l(u),a&&(a.c(),a.m(n,null))),d[0]&1024&&ee(n,"left",u[10]+4+"px")},d(u){u&&j(n),a.d(),t=!1,de(s)}}}function ks(e){let n,t;return{c(){n=he("svg"),t=he("path"),this.h()},l(s){n=fe(s,"svg",{viewBox:!0,fill:!0,width:!0,height:!0});var r=gt(n);t=fe(r,"path",{d:!0}),gt(t).forEach(j),r.forEach(j),this.h()},h(){z(t,"d","M8 5v14l11-7z"),z(n,"viewBox","0 0 24 24"),z(n,"fill","currentColor"),z(n,"width","14"),z(n,"height","14")},m(s,r){xt(s,n,r),ut(n,t)},d(s){s&&j(n)}}}function Ns(e){let n,t,s;return{c(){n=he("svg"),t=he("rect"),s=he("rect"),this.h()},l(r){n=fe(r,"svg",{viewBox:!0,fill:!0,width:!0,height:!0});var l=gt(n);t=fe(l,"rect",{x:!0,y:!0,width:!0,height:!0}),gt(t).forEach(j),s=fe(l,"rect",{x:!0,y:!0,width:!0,height:!0}),gt(s).forEach(j),l.forEach(j),this.h()},h(){z(t,"x","6"),z(t,"y","4"),z(t,"width","4"),z(t,"height","16"),z(s,"x","14"),z(s,"y","4"),z(s,"width","4"),z(s,"height","16"),z(n,"viewBox","0 0 24 24"),z(n,"fill","currentColor"),z(n,"width","14"),z(n,"height","14")},m(r,l){xt(r,n,l),ut(n,t),ut(n,s)},d(r){r&&j(n)}}}function en(e){let n,t='<svg viewBox="0 0 24 24" fill="currentColor" width="14" height="14"><path d="M3 5v4h2V5h4V3H5c-1.1 0-2 .9-2 2zm2 10H3v4c0 1.1.9 2 2 2h4v-2H5v-4zm14 4h-4v2h4c1.1 0 2-.9 2-2v-4h-2v4zm0-16h-4v2h4v4h2V5c0-1.1-.9-2-2-2z"></path></svg>',s,r;return{c(){n=dt("button"),n.innerHTML=t,this.h()},l(l){n=mt(l,"BUTTON",{class:!0,title:!0,"data-svelte-h":!0}),ne(n)!=="svelte-9j0vt3"&&(n.innerHTML=t),this.h()},h(){z(n,"class","zoom-btn svelte-1r84lea"),z(n,"title","Zoom to selection")},m(l,a){xt(l,n,a),s||(r=[$(n,"mousedown",kt(e[53])),$(n,"click",kt(e[24]))],s=!0)},p:Dt,d(l){l&&j(n),s=!1,de(r)}}}function nn(e){let n,t,s,r,l="Remove data point",a,u;return{c(){n=dt("div"),t=qt(),s=dt("div"),r=dt("button"),r.textContent=l,this.h()},l(d){n=mt(d,"DIV",{class:!0}),gt(n).forEach(j),t=It(d),s=mt(d,"DIV",{class:!0,style:!0});var f=gt(s);r=mt(f,"BUTTON",{class:!0,"data-svelte-h":!0}),ne(r)!=="svelte-8fgbhx"&&(r.textContent=l),f.forEach(j),this.h()},h(){z(n,"class","context-menu-backdrop svelte-1r84lea"),z(r,"class","context-menu-item svelte-1r84lea"),z(s,"class","context-menu svelte-1r84lea"),ee(s,"left",e[9].x+"px"),ee(s,"top",e[9].y+"px")},m(d,f){xt(d,n,f),xt(d,t,f),xt(d,s,f),ut(s,r),a||(u=[$(n,"click",e[18]),$(r,"click",e[19])],a=!0)},p(d,f){f[0]&512&&ee(s,"left",d[9].x+"px"),f[0]&512&&ee(s,"top",d[9].y+"px")},d(d){d&&(j(n),j(t),j(s)),a=!1,de(u)}}}function As(e){let n,t,s,r,l,a,u,d='<svg viewBox="0 0 24 24" fill="currentColor" width="14" height="14"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"></path></svg>',f,m,w='<svg viewBox="0 0 24 24" fill="currentColor" width="14" height="14"><path d="M19 13H5v-2h14v2z"></path></svg>',x,p,c,k='<svg viewBox="0 0 24 24" fill="currentColor" width="14" height="14"><path d="M4 4h6v6H4zm10 0h6v6h-6zM4 14h6v6H4zm10 0h6v6h-6z"></path></svg>',q,_,M,V,R=(e[7]||!e[0]&&!e[1]&&!e[2])&&$e(),T=e[3]&&e[0]&&tn(e),A=e[3]&&en(e),B=e[9]&&nn(e);return{c(){n=dt("div"),R&&R.c(),t=qt(),s=dt("canvas"),r=qt(),T&&T.c(),l=qt(),a=dt("div"),u=dt("button"),u.innerHTML=d,f=qt(),m=dt("button"),m.innerHTML=w,x=qt(),A&&A.c(),p=qt(),c=dt("button"),c.innerHTML=k,q=qt(),B&&B.c(),_=Ze(),this.h()},l(D){n=mt(D,"DIV",{class:!0,role:!0,"aria-label":!0});var H=gt(n);R&&R.l(H),t=It(H),s=mt(H,"CANVAS",{class:!0}),gt(s).forEach(j),r=It(H),T&&T.l(H),l=It(H),a=mt(H,"DIV",{class:!0});var ct=gt(a);u=mt(ct,"BUTTON",{class:!0,title:!0,"data-svelte-h":!0}),ne(u)!=="svelte-r6msr3"&&(u.innerHTML=d),f=It(ct),m=mt(ct,"BUTTON",{class:!0,title:!0,"data-svelte-h":!0}),ne(m)!=="svelte-q25joc"&&(m.innerHTML=w),x=It(ct),A&&A.l(ct),p=It(ct),c=mt(ct,"BUTTON",{class:!0,title:!0,"data-svelte-h":!0}),ne(c)!=="svelte-dflweb"&&(c.innerHTML=k),ct.forEach(j),H.forEach(j),q=It(D),B&&B.l(D),_=Ze(),this.h()},h(){z(s,"class","svelte-1r84lea"),z(u,"class","zoom-btn svelte-1r84lea"),z(u,"title","Zoom in"),z(m,"class","zoom-btn svelte-1r84lea"),z(m,"title","Zoom out"),z(c,"class","zoom-btn svelte-1r84lea"),z(c,"title","Zoom to fit"),z(a,"class","zoom-controls svelte-1r84lea"),z(n,"class","spectrogram-container svelte-1r84lea"),z(n,"role","application"),z(n,"aria-label","Spectrogram - click and drag to select, scroll to zoom, double-click to add data point"),we(n,"grabbing",e[8]),we(n,"can-grab",e[4]!==null&&!e[8])},m(D,H){xt(D,n,H),R&&R.m(n,null),ut(n,t),ut(n,s),e[58](s),ut(n,r),T&&T.m(n,null),ut(n,l),ut(n,a),ut(a,u),ut(a,f),ut(a,m),ut(a,x),A&&A.m(a,null),ut(a,p),ut(a,c),e[59](n),xt(D,q,H),B&&B.m(D,H),xt(D,_,H),M||(V=[$(window,"keydown",e[57]),$(u,"mousedown",kt(e[55])),$(u,"click",kt(e[22])),$(m,"mousedown",kt(e[54])),$(m,"click",kt(e[23])),$(c,"mousedown",kt(e[52])),$(c,"click",kt(e[25])),$(n,"mousedown",e[12]),$(n,"mousemove",e[13]),$(n,"mouseup",e[14]),$(n,"mouseleave",e[15]),$(n,"dblclick",e[16]),$(n,"contextmenu",e[17]),$(n,"wheel",e[20])],M=!0)},p(D,H){D[7]||!D[0]&&!D[1]&&!D[2]?R||(R=$e(),R.c(),R.m(n,t)):R&&(R.d(1),R=null),D[3]&&D[0]?T?T.p(D,H):(T=tn(D),T.c(),T.m(n,l)):T&&(T.d(1),T=null),D[3]?A?A.p(D,H):(A=en(D),A.c(),A.m(a,p)):A&&(A.d(1),A=null),H[0]&256&&we(n,"grabbing",D[8]),H[0]&272&&we(n,"can-grab",D[4]!==null&&!D[8]),D[9]?B?B.p(D,H):(B=nn(D),B.c(),B.m(_.parentNode,_)):B&&(B.d(1),B=null)},i:Dt,o:Dt,d(D){D&&(j(n),j(q),j(_)),R&&R.d(),e[58](null),T&&T.d(),A&&A.d(),e[59](null),B&&B.d(D),M=!1,de(V)}}}const sn=70,ve=0,Te=500,ht=45,_t=45;function on(e){const{values:n,nFreqs:t,nTimes:s}=e;if(s<=0||t<=0||!n||n.length===0)return console.warn("Invalid spectrogram data:",{nTimes:s,nFreqs:t,valuesLength:n==null?void 0:n.length}),null;const r=new ImageData(s,t);let l=-1/0;for(let f=0;f<n.length;f++)n[f]>l&&(l=n[f]);const a=10*Math.log10(l+1e-10);for(let f=0;f<s;f++)for(let m=0;m<t;m++){const w=n[m*s+f],x=10*Math.log10(w+1e-10),p=Math.max(0,Math.min(1,(x-(a-sn))/sn)),c=Math.round(255*(1-p)),k=((t-1-m)*s+f)*4;r.data[k]=c,r.data[k+1]=c,r.data[k+2]=c,r.data[k+3]=255}const u=document.createElement("canvas");return u.width=s,u.height=t,u.getContext("2d").putImageData(r,0,0),{imageData:r,canvas:u}}function Ds(e,n,t){let s,r,l,a,u,d,f,m,w,x,p,c,k,q,_,M,V,R,T,A,B;st(e,Lt,i=>t(70,m=i)),st(e,Ot,i=>t(43,w=i)),st(e,Wt,i=>t(3,x=i)),st(e,bt,i=>t(44,p=i)),st(e,pe,i=>t(11,c=i)),st(e,be,i=>t(4,k=i)),st(e,Qt,i=>t(45,q=i)),st(e,re,i=>t(46,_=i)),st(e,Xe,i=>t(71,M=i)),st(e,Ct,i=>t(47,V=i)),st(e,zt,i=>t(48,R=i)),st(e,se,i=>t(49,T=i)),st(e,xe,i=>t(50,A=i)),st(e,cn,i=>t(51,B=i));let{showPitch:D=!0}=n,{showFormants:H=!0}=n,{showIntensity:ct=!1}=n,{showHNR:L=!1}=n,{showCoG:Ft=!1}=n,{showSpectralTilt:Nt=!1}=n,{showA1P0:N=!1}=n,{showDataPoints:U=!0}=n,{maxFreq:E=5e3}=n,Q,X,o=null,Y=0,F=0,Mt,it=null,ie=null,pt=null,vt=!1,et=null,J=null,O=null,lt=!1,Z=0,ot=!1,Tt=null,St=null,Ht=null;function Vt(i,h){O&&clearTimeout(O);const g=h-i;if(r&&!it){if(g>jt){t(1,et=null),J=null;return}if(J&&(Math.min(h,J.end)-Math.max(i,J.start))/g>.9)return;O=setTimeout(async()=>{await ms(i,h),Xt(i,h)},300);return}if(!it)return;if((it.timeMax-it.timeMin)/g<2){t(1,et=null),J=null;return}J&&(Math.min(h,J.end)-Math.max(i,J.start))/g>.9||(O=setTimeout(()=>{Xt(i,h)},300))}async function Xt(i,h){if(!w||!T||!it&&!r)return;const g=Pe(),P=(h-i)*.05,y=Math.max(0,i-P),v=Math.min(w.length/m,h+P),b=Math.floor(y*m),S=Math.ceil(v*m),I=w.slice(b,S),W=new g.Sound(I,m);try{const G=Math.max(.001,(v-y)/(u*2)),nt=ke(W,.005,E,G,20),K=Ne(nt),Rt={values:K.values,freqMin:K.freqMin,freqMax:K.freqMax,timeMin:y,timeMax:v,nFreqs:K.nFreqs,nTimes:K.nTimes},Pt=on(Rt);Pt&&(et&&(t(1,et.width=0,et),t(1,et.height=0,et)),t(1,et=Pt.canvas),J={start:y,end:v}),nt.free(),ge()}finally{W.free()}}Oe(()=>{t(35,o=X.getContext("2d")),Mt=new ResizeObserver(i=>{const h=i[0].contentRect;t(36,Y=h.width),F=h.height,t(6,X.width=Y*devicePixelRatio,X),t(6,X.height=F*devicePixelRatio,X),o&&o.scale(devicePixelRatio,devicePixelRatio),ge()}),Mt.observe(Q)}),Le(()=>{Mt==null||Mt.disconnect(),O&&clearTimeout(O)});async function kn(){if(!w||!T)return;t(7,vt=!0),await Ke();const i=Pe(),h=new i.Sound(w,m);try{const g=ke(h,.005,E,.002,20),P=Ne(g);t(0,it={values:P.values,freqMin:P.freqMin,freqMax:P.freqMax,timeMin:P.timeMin,timeMax:P.timeMax,nFreqs:P.nFreqs,nTimes:P.nTimes}),t(38,Ht=E),t(1,et=null),J=null;const y=on(it);y&&(pt&&(t(37,pt.width=0,pt),t(37,pt.height=0,pt)),ie=y.imageData,t(37,pt=y.canvas)),g.free(),await Ke();const v=()=>{Y>0&&o?ge():requestAnimationFrame(v)};requestAnimationFrame(v)}finally{h.free(),t(7,vt=!1)}}function ge(){if(!o||Y===0)return;const{start:i,end:h}=p,g=M.colors;t(35,o.fillStyle=getComputedStyle(Q).getPropertyValue("--color-bg").trim()||"#1a1a1a",o),o.fillRect(0,0,Y,F),t(35,o.fillStyle=getComputedStyle(Q).getPropertyValue("--color-surface").trim()||"#2a2a2a",o),o.fillRect(0,0,ht,F),o.fillRect(Y-_t,0,_t,F);const P=et&&J&&i>=J.start&&h<=J.end;if(l&&!P)t(35,o.fillStyle="rgba(255, 255, 255, 0.6)",o),t(35,o.font="14px sans-serif",o),t(35,o.textAlign="center",o),t(35,o.textBaseline="middle",o),o.fillText("Zoom in for spectrogram",ht+u/2,F/2);else if(P&&et&&J){const b=et,S=J.start,I=J.end,W=b.width,G=b.height,nt=Math.floor((i-S)/(I-S)*W),K=Math.ceil((h-i)/(I-S)*W);t(35,o.imageSmoothingEnabled=!0,o),o.drawImage(b,Math.max(0,nt),0,Math.min(K,W-nt),G,ht,0,u,F)}else if(it&&pt){const{timeMin:b,timeMax:S,nTimes:I,nFreqs:W,freqMax:G}=it,nt=Math.floor((i-b)/(S-b)*I),K=Math.ceil((h-i)/(S-b)*I),Rt=Math.min(1,E/G),Pt=Math.floor(W*Rt),$t=W-Pt;t(35,o.imageSmoothingEnabled=!1,o),o.drawImage(pt,Math.max(0,nt),$t,Math.min(K,I-nt),Pt,ht,0,u,F)}if(x){const b=Math.max(x.start,i),S=Math.min(x.end,h);if(S>b){const I=yt(b,i,h),W=yt(S,i,h);t(35,o.fillStyle=g.selection.fill,o),o.fillRect(I,0,W-I,F)}}if(R!==null){const b=yt(R,i,h);b>=ht&&b<=d&&(t(35,o.strokeStyle=g.cursor,o),t(35,o.lineWidth=1,o),o.setLineDash([4,4]),o.beginPath(),o.moveTo(b,0),o.lineTo(b,F),o.stroke(),o.setLineDash([]))}const v=yt(V,i,h);v>=ht&&v<=d&&(t(35,o.strokeStyle=g.cursor,o),t(35,o.lineWidth=g.cursorWidth,o),o.beginPath(),o.moveTo(v,0),o.lineTo(v,F),o.stroke()),_&&(D&&Dn(i,h),H&&Cn(i,h),ct&&Fn(i,h),L&&Rn(i,h),Ft&&In(i,h),Nt&&qn(i,h),N&&zn(i,h)),U&&En(i,h),Nn(),D&&An()}function Nn(){if(!o)return;t(35,o.fillStyle="rgba(255, 255, 255, 0.8)",o),t(35,o.font="10px sans-serif",o),t(35,o.textAlign="right",o);const i=E<=5e3?1e3:E<=7500?1500:2e3;for(let h=0;h<=E;h+=i){const g=F-h/E*F,P=h>=1e3?`${h/1e3}k`:`${h}`;o.fillText(P,ht-4,g+3),t(35,o.strokeStyle="rgba(255, 255, 255, 0.3)",o),t(35,o.lineWidth=1,o),o.beginPath(),o.moveTo(ht-2,g),o.lineTo(ht,g),o.stroke()}o.save(),o.translate(12,F/2),o.rotate(-Math.PI/2),t(35,o.textAlign="center",o),t(35,o.fillStyle="rgba(255, 255, 255, 0.6)",o),t(35,o.font="9px sans-serif",o),o.fillText("Frequency (Hz)",0,0),o.restore()}function An(){if(!o)return;t(35,o.fillStyle="#60a5fa",o),t(35,o.font="10px sans-serif",o),t(35,o.textAlign="left",o);const i=100;for(let h=0;h<=Te;h+=i){const g=qe(h);o.fillText(`${h}`,Y-_t+4,g+3),t(35,o.strokeStyle="rgba(96, 165, 250, 0.3)",o),t(35,o.lineWidth=1,o),o.beginPath(),o.moveTo(Y-_t,g),o.lineTo(Y-_t+2,g),o.stroke()}o.save(),o.translate(Y-8,F/2),o.rotate(Math.PI/2),t(35,o.textAlign="center",o),t(35,o.fillStyle="rgba(96, 165, 250, 0.6)",o),t(35,o.font="9px sans-serif",o),o.fillText("Pitch (Hz)",0,0),o.restore()}function Dn(i,h){if(!o||!_)return;const{times:g,pitch:P}=_,y=M.colors;t(35,o.strokeStyle=y.pitch,o),t(35,o.lineWidth=y.pitchWidth,o),o.beginPath();let v=!1;for(let b=0;b<g.length;b++){const S=g[b],I=P[b];if(S<i||S>h)continue;if(I===null||I<=ve||I>Te){v=!1;continue}const W=yt(S,i,h),G=qe(I);v?o.lineTo(W,G):(o.moveTo(W,G),v=!0)}o.stroke(),t(35,o.fillStyle=y.pitch,o);for(let b=0;b<g.length;b++){const S=g[b],I=P[b];if(S<i||S>h||I===null||I<=ve||I>Te)continue;const W=yt(S,i,h),G=qe(I);o.beginPath(),o.arc(W,G,2,0,Math.PI*2),o.fill()}}function Cn(i,h){if(!o||!_)return;const{times:g,formants:P}=_,y=M.colors.formant,v=[y.f1,y.f2,y.f3,y.f4],b=[P.f1,P.f2,P.f3,P.f4];for(let S=0;S<4;S++){const I=b[S];t(35,o.fillStyle=v[S],o);for(let W=0;W<g.length;W++){const G=g[W],nt=I[W];if(G<i||G>h||nt===null||nt>E)continue;const K=yt(G,i,h),Rt=Ie(nt);o.beginPath(),o.arc(K,Rt,y.size,0,Math.PI*2),o.fill()}}}function Fn(i,h){if(!o||!_)return;const{times:g,intensity:P}=_;t(35,o.strokeStyle="#4ade80",o),t(35,o.lineWidth=2,o),o.beginPath();let y=!1;const v=30,b=90;for(let S=0;S<g.length;S++){const I=g[S],W=P[S];if(I<i||I>h)continue;if(W===null){y=!1;continue}const G=yt(I,i,h),nt=(W-v)/(b-v),K=F-nt*F*.8-F*.1;y?o.lineTo(G,K):(o.moveTo(G,K),y=!0)}o.stroke()}function Rn(i,h){if(!o||!_)return;const{times:g,harmonicity:P}=_;t(35,o.strokeStyle="#fbbf24",o),t(35,o.lineWidth=2,o),o.beginPath();let y=!1;const v=-10,b=40;for(let S=0;S<g.length;S++){const I=g[S],W=P[S];if(I<i||I>h)continue;if(W===null){y=!1;continue}const G=yt(I,i,h),nt=(W-v)/(b-v),K=F-nt*F*.8-F*.1;y?o.lineTo(G,K):(o.moveTo(G,K),y=!0)}o.stroke()}function In(i,h){if(!o||!_||!_.cog)return;const{times:g,cog:P}=_;t(35,o.fillStyle="#c084fc",o);for(let y=0;y<g.length;y++){const v=g[y],b=P[y];if(v<i||v>h||b===null||b>E)continue;const S=yt(v,i,h),I=Ie(b);o.beginPath(),o.arc(S,I,2.5,0,Math.PI*2),o.fill()}}function qn(i,h){if(!o||!_||!_.spectralTilt)return;const{times:g,spectralTilt:P}=_;t(35,o.strokeStyle="#22d3ee",o),t(35,o.lineWidth=2,o),o.beginPath();let y=!1;const v=0,b=40;for(let S=0;S<g.length;S++){const I=g[S],W=P[S];if(I<i||I>h)continue;if(W===null){y=!1;continue}const G=yt(I,i,h),nt=(W-v)/(b-v),K=F-nt*F*.8-F*.1;y?o.lineTo(G,K):(o.moveTo(G,K),y=!0)}o.stroke()}function zn(i,h){if(!o||!_||!_.a1p0)return;const{times:g,a1p0:P}=_;t(35,o.strokeStyle="#fb7185",o),t(35,o.lineWidth=2,o),o.beginPath();let y=!1;const v=-20,b=20;for(let S=0;S<g.length;S++){const I=g[S],W=P[S];if(I<i||I>h)continue;if(W===null){y=!1;continue}const G=yt(I,i,h),nt=(W-v)/(b-v),K=F-nt*F*.8-F*.1;y?o.lineTo(G,K):(o.moveTo(G,K),y=!0)}o.stroke()}function En(i,h){if(!o)return;const g=q;for(const P of g){if(P.time<i||P.time>h)continue;const y=yt(P.time,i,h),v=Ie(P.frequency),b=k===P.id;t(35,o.strokeStyle=b?"#ff6b6b":"#ffcc00",o),t(35,o.lineWidth=b?2:1,o),o.setLineDash([3,3]),o.beginPath(),o.moveTo(y,0),o.lineTo(y,F),o.stroke(),o.setLineDash([]),t(35,o.fillStyle=b?"#ff6b6b":"#ffcc00",o),o.beginPath(),o.arc(y,v,b?6:4,0,Math.PI*2),o.fill(),t(35,o.strokeStyle="#000",o),t(35,o.lineWidth=1,o),o.beginPath(),o.arc(y,v,b?6:4,0,Math.PI*2),o.stroke(),t(35,o.fillStyle="#ffcc00",o),t(35,o.font="10px sans-serif",o),t(35,o.textAlign="center",o),o.fillText(`P${P.id}`,y,12)}}function Ie(i){return F-i/E*F}function ye(i){return(1-i/F)*E}function qe(i){return F-(i-ve)/(Te-ve)*F}function yt(i,h,g){return ht+(i-h)/(g-h)*u}function le(i,h,g){return u<=0?h:h+(i-ht)/u*(g-h)}function Bn(i){document.activeElement instanceof HTMLInputElement&&document.activeElement.blur();const h=X.getBoundingClientRect(),g=i.clientX-h.left,P=i.clientY-h.top;if(g<ht||g>Y-_t)return;const y=le(g,p.start,p.end),v=ye(P);if(U){const b=Me(y,v,.02,E*.05);if(b){Kt(),t(8,ot=!0),Tt=b.id,xe.set(b.id);return}}lt=!0,Z=y,Ct.set(y),Wt.set(null)}function Wn(i){const h=X.getBoundingClientRect(),g=i.clientX-h.left,P=i.clientY-h.top;if(g<ht||g>Y-_t){zt.set(null),ot||be.set(null);return}const y=le(g,p.start,p.end),v=ye(P);if(zt.set(y),ot&&Tt!==null){Ss(Tt,y,v);return}if(U){const b=Me(y,v,.02,E*.05);be.set((b==null?void 0:b.id)??null)}lt&&(Math.abs(y-Z)>.001&&Wt.set({start:Math.min(Z,y),end:Math.max(Z,y)}),Ct.set(y))}function On(){ot&&(t(8,ot=!1),Tt=null,xe.set(null)),lt=!1}function Ln(){ot&&(t(8,ot=!1),Tt=null,xe.set(null)),lt=!1,zt.set(null),be.set(null)}function Hn(i){if(!U)return;const h=X.getBoundingClientRect(),g=i.clientX-h.left,P=i.clientY-h.top;if(g<ht||g>Y-_t)return;const y=le(g,p.start,p.end),v=ye(P);Me(y,v,.02,E*.05)||_n(y,v)}function Vn(i){if(!U)return;const h=X.getBoundingClientRect(),g=i.clientX-h.left,P=i.clientY-h.top;if(g<ht||g>Y-_t)return;const y=le(g,p.start,p.end),v=ye(P),b=Me(y,v,.02,E*.05);b&&(i.preventDefault(),t(9,St={x:i.clientX,y:i.clientY,pointId:b.id}))}function Je(){t(9,St=null)}function Xn(){St&&(Ts(St.pointId),t(9,St=null))}function Gn(i){i.preventDefault();const h=X.getBoundingClientRect(),g=i.clientX-h.left,P=le(g,p.start,p.end),y=w?w.length/m:10,{start:v,end:b}=p,S=b-v;if(Math.abs(i.deltaX)>Math.abs(i.deltaY)){const Rt=i.deltaX/u*S;let Pt=v+Rt,$t=b+Rt;Pt<0&&(Pt=0,$t=S),$t>y&&($t=y,Pt=y-S),bt.set({start:Pt,end:$t});return}const I=i.deltaY>0?1.1:.91,W=Math.max(.01,Math.min(y,S*I)),G=(P-v)/S,nt=Math.max(0,P-G*W),K=Math.min(y,nt+W);bt.set({start:Math.max(0,K-W),end:K})}function jn(){x&&(c?De():Ge(x.start,x.end))}function Un(){const i=w?w.length/m:10,{start:h,end:g}=p,P=g-h,y=(h+g)/2,v=Math.max(.01,P*.7),b=Math.max(0,y-v/2),S=Math.min(i,b+v);bt.set({start:Math.max(0,S-v),end:S})}function Yn(){const i=w?w.length/m:10,{start:h,end:g}=p,P=g-h,y=(h+g)/2,v=Math.min(i,P*1.4),b=Math.max(0,y-v/2),S=Math.min(i,b+v);bt.set({start:Math.max(0,S-v),end:S})}function Jn(){if(!x)return;const i=(x.end-x.start)*.1,h=w?w.length/m:10;bt.set({start:Math.max(0,x.start-i),end:Math.min(h,x.end+i)})}function Zn(){const i=w?w.length/m:10;bt.set({start:0,end:i})}function Kn(i){ae.call(this,e,i)}function Qn(i){ae.call(this,e,i)}function $n(i){ae.call(this,e,i)}function ts(i){ae.call(this,e,i)}function es(i){ae.call(this,e,i)}const ns=i=>i.key==="Escape"&&St&&Je();function ss(i){oe[i?"unshift":"push"](()=>{X=i,t(6,X)})}function os(i){oe[i?"unshift":"push"](()=>{Q=i,t(5,Q)})}return e.$$set=i=>{"showPitch"in i&&t(26,D=i.showPitch),"showFormants"in i&&t(27,H=i.showFormants),"showIntensity"in i&&t(28,ct=i.showIntensity),"showHNR"in i&&t(29,L=i.showHNR),"showCoG"in i&&t(30,Ft=i.showCoG),"showSpectralTilt"in i&&t(31,Nt=i.showSpectralTilt),"showA1P0"in i&&t(32,N=i.showA1P0),"showDataPoints"in i&&t(33,U=i.showDataPoints),"maxFreq"in i&&t(34,E=i.maxFreq)},e.$$.update=()=>{e.$$.dirty[1]&8192&&t(42,s=p.end-p.start),e.$$.dirty[1]&1048576&&t(40,r=B>jt),e.$$.dirty[1]&2560&&t(2,l=r&&s>jt),e.$$.dirty[0]&1|e.$$.dirty[1]&266888&&w&&T&&!r&&(!it||E!==Ht)&&kn(),e.$$.dirty[0]&2080374814|e.$$.dirty[1]&778367&&t(41,a=[o,pt,et,Y,p,x,V,R,_,q,k,A,E,D,H,ct,L,Ft,Nt,N,U,l]),e.$$.dirty[0]&6|e.$$.dirty[1]&1136&&a&&o&&Y>0&&(pt||l||et)&&ge(),e.$$.dirty[1]&32&&t(39,u=Math.max(0,Y-ht-_t)),e.$$.dirty[0]&1|e.$$.dirty[1]&275200&&p&&w&&T&&u>0&&(it||r)&&Vt(p.start,p.end),e.$$.dirty[1]&32&&(d=Y-_t),e.$$.dirty[0]&8|e.$$.dirty[1]&8224&&t(10,f=x&&Y>0?yt(Math.max(x.start,p.start),p.start,p.end):0)},[it,et,l,x,k,Q,X,vt,ot,St,f,c,Bn,Wn,On,Ln,Hn,Vn,Je,Xn,Gn,jn,Un,Yn,Jn,Zn,D,H,ct,L,Ft,Nt,N,U,E,o,Y,pt,Ht,u,r,a,s,w,p,q,_,V,R,T,A,B,Kn,Qn,$n,ts,es,ns,ss,os]}class io extends He{constructor(n){super(),Ve(this,n,Ds,As,We,{showPitch:26,showFormants:27,showIntensity:28,showHNR:29,showCoG:30,showSpectralTilt:31,showA1P0:32,showDataPoints:33,maxFreq:34},null,[-1,-1,-1])}}function Cs(e){let n,t;return{c(){n=dt("div"),t=dt("canvas"),this.h()},l(s){n=mt(s,"DIV",{class:!0});var r=gt(n);t=mt(r,"CANVAS",{class:!0}),gt(t).forEach(j),r.forEach(j),this.h()},h(){z(t,"class","svelte-1ubvkuo"),z(n,"class","time-axis svelte-1ubvkuo")},m(s,r){xt(s,n,r),ut(n,t),e[5](t),e[6](n)},p:Dt,i:Dt,o:Dt,d(s){s&&j(n),e[5](null),e[6](null)}}}let rn=24;function Fs(e,n){if(n>=60){const t=Math.floor(e/60),s=Math.floor(e%60);return`${t}:${s.toString().padStart(2,"0")}`}else return n>=1?e.toFixed(0)+"s":n>=.1?e.toFixed(1):n>=.01?e.toFixed(2):e.toFixed(3)}function Rs(e,n,t){let s;st(e,bt,x=>t(4,s=x));let r,l,a=null,u=0,d;Oe(()=>{t(2,a=l.getContext("2d")),d=new ResizeObserver(x=>{const p=x[0].contentRect;t(3,u=p.width),t(1,l.width=u*devicePixelRatio,l),t(1,l.height=rn*devicePixelRatio,l),a&&a.scale(devicePixelRatio,devicePixelRatio),f()}),d.observe(r)}),Le(()=>{d==null||d.disconnect()});function f(){if(!a||u===0)return;const{start:x,end:p}=s,c=p-x;t(2,a.fillStyle="#2d2d2d",a),a.fillRect(0,0,u,rn);const k=Math.floor(u/80),q=c/k;let M=[.001,.002,.005,.01,.02,.05,.1,.2,.5,1,2,5,10,30,60].find(T=>T>=q)||60;t(2,a.strokeStyle="#606060",a),t(2,a.fillStyle="#a0a0a0",a),t(2,a.font="10px sans-serif",a),t(2,a.textAlign="center",a);const V=Math.ceil(x/M)*M;for(let T=V;T<=p;T+=M){const A=(T-x)/c*u;a.beginPath(),a.moveTo(A,0),a.lineTo(A,6),a.stroke();const B=Fs(T,M);a.fillText(B,A,18)}const R=M/5;if(R>=.001){t(2,a.strokeStyle="#404040",a);const T=Math.ceil(x/R)*R;for(let A=T;A<=p;A+=R){const B=(A-x)/c*u;a.beginPath(),a.moveTo(B,0),a.lineTo(B,3),a.stroke()}}}function m(x){oe[x?"unshift":"push"](()=>{l=x,t(1,l)})}function w(x){oe[x?"unshift":"push"](()=>{r=x,t(0,r)})}return e.$$.update=()=>{e.$$.dirty&28&&a&&u>0&&s&&f()},[r,l,a,u,s,m,w]}class lo extends He{constructor(n){super(),Ve(this,n,Rs,Cs,We,{})}}export{Us as A,Ys as B,so as C,Js as D,Zs as E,vs as F,Qs as G,Ks as H,ft as I,Gs as J,oo as K,ro as L,ue as M,Qt as N,js as O,io as S,lo as T,Os as W,Ot as a,Ct as b,Vs as c,cn as d,Wt as e,Ws as f,re as g,pe as h,Ls as i,Ae as j,rt as k,De as l,Ge as m,Jt as n,Kt as o,Xs as p,to as q,Hs as r,Lt as s,bt as t,zt as u,no as v,se as w,Ms as x,$s as y,eo as z};
